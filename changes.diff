diff -ur snd-10/clm-ins.scm snd-10-new/clm-ins.scm
--- snd-10/clm-ins.scm	2009-08-05 01:01:09.000000000 +0200
+++ snd-10-new/clm-ins.scm	2010-11-18 01:12:51.630979832 +0100
@@ -980,6 +980,12 @@
 		      (* lamp4 ampval (oscil gen4 (* (+ (* (+ dev04 (* indval dev14)) modval) frqval) harm4)))))))))))
 
 
+
+
+;; END ANALYSIS, Master thesis.
+
+
+
 ;;; NREV (the most popular Samson box reverb)
 
 (definstrument (nrev :key (reverb-factor 1.09) (lp-coeff 0.7) (volume 1.0))
diff -ur snd-10/eval-c.scm snd-10-new/eval-c.scm
--- snd-10/eval-c.scm	2009-08-05 01:01:09.000000000 +0200
+++ snd-10-new/eval-c.scm	2010-11-18 01:13:47.209915577 +0100
@@ -1238,14 +1238,14 @@
      (<int> ai2)
      (<int> (define (c-scale (<float> x)
 			     (<float> x1)
-				   (<float> x2)
-				   (<float> y1)
-				   (<float> y2))
-		    (return (+ (-> this gakk)
-			       ;;(this->gakk2)
-			       y1
-			       (/ (* (- x x1) (- y2 y1))
-				  (- x2 x1)))))))
+			     (<float> x2)
+			     (<float> y1)
+			     (<float> y2))
+	      (return (+ (-> this gakk)
+			 ;;(this->gakk2)
+			 y1
+			 (/ (* (- x x1) (- y2 y1))
+			    (- x2 x1)))))))
     
     (define (destructor)
       (c-display "killed me"))
@@ -1882,7 +1882,7 @@
 			    (<-> "-Wall " (or (getenv "CFLAGS") "") " " (if (getenv "LDFLAGS") (getenv "LDFLAGS") "") " "))
 			(string #\`) guile-config " compile" (string #\`) " "
 			compile-options)))
-    (if (not (= 0 (system (<-> *eval-c-compiler* " -O3 -fPIC -shared -o " libfile " " sourcefile " -g " ;" -fomit-frame-pointer "
+    (if (not (= 0 (system (<-> *eval-c-compiler* " -O3 -fPIC -shared -march=native -o " libfile " " sourcefile " -g " ;" -fomit-frame-pointer "
 			       (if (string=? *eval-c-compiler* "icc")
 				   "-L/opt/intel_cc_80/lib /opt/intel_cc_80/lib/libimf.a"
 				   (<-> "-Wall " (or (getenv "CFLAGS") "") " " (if (getenv "LDFLAGS") (getenv "LDFLAGS") "") " "))
diff -ur snd-10/oo.scm snd-10-new/oo.scm
--- snd-10/oo.scm	2009-08-05 01:01:09.000000000 +0200
+++ snd-10-new/oo.scm	2010-11-18 01:13:26.321008816 +0100
@@ -109,16 +109,10 @@
 ;; Snd has its own filter function (a clm function) overriding the guile filter function. This affects
 ;; remove, because remove is based on filter. Redefine remove:
 (define (remove pred list)
-  (if (null? list)
-      '()
-      (if (pred (car list))
-	  (remove pred (cdr list))
-	  (cons (car list) (remove pred (cdr list))))))
-
-;; Snd has its own filter function (a clm function) overriding the guile filter function.
-(define (filter-org pred list)
-  (remove (lambda (e) (not (pred e)))
-	  list))
+  (%filter (lambda (e) (not (pred e)))
+	   list))
+
+(define filter-org %filter)
 
 (define <-> string-append)
 (define <_> symbol-append)
@@ -221,6 +215,57 @@
 	       (deep-list-copy (cdr list))))))
 
 
+(define (split-list n list kont)
+  (let loop ((n n)
+	     (ret '())
+	     (list list))
+    (if (or (= n 0)
+	    (null? list))
+	(kont (reverse! ret) list)
+	(loop (1- n)
+	      (cons (car list) ret)
+	      (cdr list)))))
+#|
+(split-list 3 '(a b c d e f) c-display)
+|#
+
+(define (zipn n list)
+  (if (null? list)
+      '()
+      (split-list n list
+		  (lambda (elements rest)
+		    (cons elements (zipn n rest))))))
+
+#|
+(zipn 2 '(a b c d e f))
+|#
+
+(define (cl-car a)
+  (and (pair? a) (car a)))
+
+(define (cl-cdr a)
+  (and (pair? a) (cdr a)))
+
+(define (cl-cadr a)
+  (cl-car (cl-cdr a)))
+#!
+(cl-cadr #f)
+!#
+
+(define (cl-cddr a)
+  (cl-cdr (cl-cdr a)))
+
+(define (cl-nth n a)
+  (cond ((< n 0)
+	 #f)
+	((= n 0)
+	 (cl-car a))
+	(else
+	 (cl-nth (1- n) (cl-cdr a)))))
+#!
+(cl-nth 5 '(0 1 2 3 4))
+!#
+
 
 (define (c-integer somekindofnumberorsomething)
 ;;    somekindofnumberorsomething)
@@ -242,6 +287,27 @@
        (lambda (n) (display n)(newline)))
 !#
 
+(define-macro (range name das-start das-end . body)
+  (define start (gensym "start"))
+  (define end (gensym "end"))
+  (define loop (gensym "rangeloop"))
+  `(let ((,start ,das-start)
+         (,end ,das-end))
+     (let ,loop ((,name ,start))
+          (when (< ,name ,end)
+            ,@body
+            (,loop (1+ ,name))))))
+
+
+#!
+(define (c-for-each func . lists)
+  (let loop ((n 0)
+	     (lists lists))
+    (when (pair? lists)
+      (apply func (map car lists))
+      (loop (1+ n)
+	    (cdr lists)))))
+!#
 
 (define (c-for-each func . lists)
   (let ((n 0))
@@ -299,6 +365,54 @@
 
 
 
+;; Copied from: http://www.koders.com/scheme/fidB93E3B571CB3B2114FB1BD9839EF09D19B5B89A9.aspx?s=sort
+;; (slightly modified -Kjetil)
+;;
+;;; "tsort.scm" Topological sort
+;;; Copyright (C) 1995 Mikael Djurfeldt
+;;
+;; This code is in the public domain.
+;;
+(define (topological-sort dag)
+  (if (null? dag)
+      '()
+      (let* ((adj-table (make-hash-table 219))
+	     (insert hashq-set!)
+	     (lookup hashq-ref)
+	     (sorted '()))
+	(letrec ((visit (lambda (u adj-list)
+                          ;; Color vertex u
+                          (insert adj-table u 'colored)
+                          ;; Visit uncolored vertices which u connects to
+                          (for-each (lambda (v)
+                                      (let ((val (lookup adj-table v)))
+                                        (if (not (eq? val 'colored))
+                                            (visit v (or val '())))))
+                                    adj-list)
+                          ;; Since all vertices downstream u are visited
+                          ;; by now, we can safely put u on the output list
+                          (push! u sorted))))
+	  ;; Hash adjacency lists
+	  (for-each (lambda (def)
+		      (insert adj-table (car def) (cdr def)))
+		    (cdr dag))
+	  ;; Visit vertices
+	  (visit (caar dag) (cdar dag))
+	  (for-each (lambda (def)
+		      (let ((val (lookup adj-table (car def))))
+			(if (not (eq? val 'colored))
+			    (visit (car def) (cdr def)))))
+		    (cdr dag)))
+	sorted)))
+
+#!
+(topological-sort '((a bbb c)
+		    (bbb c ddd)
+		    (ddd e f)))
+!#
+
+
+
 
 
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
@@ -380,7 +494,6 @@
                  (cdr optkeys*)
                  (cdr keyargs*)))))
 
-  ;;(c-display "keyargs" keyargs)
   ;;(c-display "res" res)
 
   ;; Parse key args and build rest.
@@ -1038,13 +1151,23 @@
 	      (expr expr))
 
     (define (blockhandlerfunc varlist expr)
-      ;;(c-display "blockhandlerfunc" varlist expr)
+      (define defines (map (lambda (def)
+			     (let ((name (let loop ((sec (cadr def)))
+					   (if (pair? sec)
+					       (loop (car sec))
+					       sec))))
+			       name))
+			   (%filter (lambda (expr)
+				      (and (pair? expr)
+					   (eq? 'define (car expr))))
+				    expr)))
+      ;;(c-display "blockhandlerfunc" varlist expr defines)
       (if (not blockhandler)
 	  (map (lambda (expr)
-		 (parse varlist expr))
+		 (parse (append defines varlist) expr))
 	       expr)
 	  (begin
-	    (set! schemecodeparser-varlist varlist)
+	    (set! schemecodeparser-varlist (append defines varlist))
 	    (blockhandler expr))))
 
     ;; Like append, but varlist1 might not be a valid list (in case of optional arguments)
@@ -1075,6 +1198,7 @@
 	       (nullfunc expr)
 	       expr))
 	  ((pair? (car expr))
+           ;;(c-display "hepp" (car expr))
 	   (if pairfunc
 	       (pairfunc expr)
 	       (blockhandlerfunc varlist expr)))
@@ -1087,10 +1211,10 @@
 	  ((eq? 'define (car expr))
 	   `(define ,(cadr expr)
 	      ,@(blockhandlerfunc (append-varlists (cadr expr) varlist) (cddr expr))))
-	  ((eq? 'delay (car expr))
-	   `(delay ,@(blockhandlerfunc varlist (cdr expr))))
-	  ((eq? 'force (car expr))
-	   `(force ,@(blockhandlerfunc varlist (cdr expr))))
+;;;	  ((eq? 'delay (car expr))
+;;;	   `(delay ,@(blockhandlerfunc varlist (cdr expr))))
+;;;	  ((eq? 'force (car expr))
+;;;	   `(force ,@(blockhandlerfunc varlist (cdr expr))))
           ((eq? 'begin (car expr))
            `(begin
               ,@(blockhandlerfunc varlist (cdr expr))))
@@ -1113,9 +1237,9 @@
 	     `(let ,(cadr expr) ,vars
 		   ,@(blockhandlerfunc newvars (cdddr expr)))))
 	  ((eq? 'let (car expr))
-	   (let ((vars (map (lambda (a)
-			 `(,(car a) ,@(blockhandlerfunc varlist (cdr a))))
-		       (cadr expr))))
+	   (let ((vars (map (lambda (a)			      
+			      `(,(car a) ,@(blockhandlerfunc varlist (cdr a))))
+			    (cadr expr))))
 	     `(let ,vars
 		,@(blockhandlerfunc (append (map car (cadr expr))
 					    varlist)
@@ -1202,6 +1326,11 @@
                                                     (cdr expr))))))))
 #!
 (schemecodeparser '(begin `(+ ,a 3)))
+(schemecodeparser '(let ()
+		     (define ((a)) 9)
+		     (+ 2 3 a)
+		     (define b 60)
+		     (+ a b)))
 !#
 
 (define (fix-defines-do terms)
diff -ur snd-10/peak-phases.scm snd-10-new/peak-phases.scm
--- snd-10/peak-phases.scm	2009-08-05 01:01:09.000000000 +0200
+++ snd-10-new/peak-phases.scm	2010-11-18 01:12:47.833914598 +0100
@@ -1742,8 +1742,8 @@
 #(41 7.86743174872036 #(0 1 0 0 1 1 1 1 1 1 1 1 0 1 0 1 0 0 1 1 1 0 1 0 0 1 1 0 1 0 1 1 0 0 1 1 1 1 1 0 0)
      7.7093445316966 #(0 1 1 0 1 0 1 1 1 1 0 0 0 0 1 1 0 0 0 0 0 0 1 1 0 1 1 1 0 0 0 1 0 0 1 0 1 1 1 0 1)
 
+     6.734307 #(0.000000 1.618436 1.642336 0.907491 0.377229 -0.125626 0.839163 1.474421 0.976983 0.336938 0.257661 0.846753 1.149993 1.813577 1.420274 0.813851 1.466314 1.802089 0.332264 0.357519 0.526874 1.194843 1.367931 0.862496 -0.072085 0.604632 -0.174047 0.749598 1.616691 1.262436 0.568540 0.587308 1.468794 0.380257 1.431345 1.769428 1.797596 1.654141 -0.068896 1.341165 1.400628)
      6.702553 #(0.000000 1.630302 1.296324 0.829400 0.222533 1.275019 1.539346 1.253635 -0.112100 1.531202 -0.003082 1.407560 -0.086878 0.290919 0.488917 0.077712 0.344896 0.825931 1.442369 0.182764 1.643343 -0.106059 0.060929 0.903785 1.596812 1.363634 -0.271478 0.657063 1.072097 -0.206317 0.780192 -0.049363 1.227189 1.070038 0.133490 1.521037 0.273418 1.684896 1.093510 0.867218 0.932803)
-     6.693168 #(0.000000 0.292656 1.607761 0.490028 0.557584 1.636478 0.685414 0.294339 1.858733 0.575584 1.278395 0.927672 0.946867 1.528845 0.598186 0.429807 0.530685 0.317304 1.890696 1.131985 0.535534 0.594577 0.105721 0.663036 0.710392 1.890674 0.620655 0.697346 1.443798 -0.005911 0.169662 1.055813 1.530133 0.903003 1.646143 0.952965 1.623160 1.238006 1.636299 0.288276 0.090356)
      )
 
 ;;; 42 odd -------------------------------------------------------------------------------- ; sqrt 6.4807
@@ -1855,7 +1855,7 @@
 #(55 9.3425494397445 #(0 1 0 0 1 1 1 0 0 0 0 1 1 0 1 1 0 0 0 0 0 1 0 1 0 1 1 0 1 1 1 1 1 1 1 1 1 0 0 0 1 1 1 0 1 0 1 0 1 1 0 0 1 1 0)
      9.2039985656738 #(0 0 1 1 1 0 1 0 0 1 1 1 0 1 0 0 1 1 0 1 1 1 0 1 1 1 0 0 0 1 1 1 0 1 0 0 1 0 0 0 0 0 0 0 1 1 0 1 0 1 0 0 1 1 1)
 
-     8.045199 #(0.000000 1.494916 0.502608 0.367966 0.433430 0.018649 0.065123 0.709172 -0.067590 0.264751 1.317149 0.377706 0.303404 0.688208 1.007825 1.612096 1.026848 -1.950045 1.307030 1.742089 0.245678 1.634915 1.824068 1.163929 1.294328 -0.099260 1.961370 0.114858 0.728240 0.724933 1.689106 -0.047755 0.817256 1.450068 0.752717 0.342048 1.259756 0.201064 1.707920 0.185182 0.703522 0.457769 0.909367 0.592473 0.257630 1.563733 1.558752 1.114946 -0.142020 1.676389 0.996429 -0.255620 0.970512 0.936548 0.683860)
+     8.057007 #(0.000000 0.903693 1.726270 1.000270 1.378474 1.062932 0.633047 1.008462 0.130408 0.567311 -0.004235 -0.382373 1.581692 1.671948 0.445470 1.500436 1.153145 0.995162 0.185871 0.489117 1.132403 0.237904 0.629475 0.315766 0.639947 0.906934 0.788848 0.839439 0.434769 1.114525 0.359368 0.424091 1.470873 1.081373 0.170194 -0.284126 0.978112 0.265614 1.023207 1.213625 -0.020179 0.486050 0.531299 1.114783 1.065892 1.254185 0.785284 1.579205 -0.089327 0.058446 1.179048 0.628449 0.371876 0.623985 1.821420)
      )
 
 ;;; 56 odd --------------------------------------------------------------------------------
@@ -1893,7 +1893,7 @@
 #(60 9.8824768066406 #(0 1 0 1 1 1 1 1 1 0 1 0 1 0 0 1 0 1 1 1 1 1 0 1 0 1 1 0 0 1 1 1 1 1 0 0 0 0 1 1 0 0 1 0 0 0 1 0 1 1 0 0 1 1 1 0 1 1 1 0)
      9.6560277938843 #(0 1 0 0 0 1 0 0 1 0 0 1 1 1 1 1 1 1 1 0 1 0 0 1 0 1 0 0 1 0 0 1 1 0 0 0 0 0 0 1 0 0 0 1 1 1 0 0 0 0 1 0 1 1 1 0 0 1 0 0)
 
-     8.503888 #(0.000000 0.991710 0.754429 0.994109 0.514045 0.319530 1.181536 0.492812 -0.307742 0.647985 0.079359 1.842993 0.406997 1.769206 0.943436 0.777419 1.858400 0.321558 0.126027 1.921827 1.851337 0.376160 1.181685 1.592879 -0.049633 1.136291 1.178377 0.615806 1.104200 1.866857 1.298612 1.781207 -1.959863 1.524380 0.537637 1.292069 0.405693 1.451549 1.892406 1.657762 1.131993 1.619031 0.658481 1.904240 1.280560 0.455499 0.539866 -0.094281 1.656815 0.072174 0.167507 0.653899 0.378839 0.098102 1.712189 0.414239 0.822319 1.253870 1.236433 -0.020003)
+     8.515605 #(0.000000 1.623811 1.404275 1.431383 1.054828 0.852612 0.201604 0.473738 1.183294 0.585023 0.197860 1.185808 0.723977 0.699499 1.556381 0.083825 0.048086 0.848934 0.458867 0.569988 0.368142 0.860345 0.517389 0.877747 0.459844 0.891866 1.891360 1.441179 0.542902 0.327576 0.316874 0.944585 -0.033631 1.293581 1.290417 0.554819 1.034802 0.273543 1.404036 0.726433 1.823065 1.733283 1.364435 1.570530 0.611482 1.105171 0.399648 0.335996 0.984318 0.136478 1.769877 0.275495 0.855808 1.774147 -1.939696 0.905229 0.998772 0.857784 1.586961 1.556789)
      )
 
 ;;; 61 odd --------------------------------------------------------------------------------
@@ -1911,7 +1911,7 @@
      9.8772821666628 #(0 1 1 1 0 1 0 0 1 0 0 1 0 1 1 0 1 1 1 0 1 1 0 1 1 0 1 1 1 0 0 1 0 0 1 1 0 1 1 1 1 0 1 1 1 0 1 0 1 0 0 1 0 0 0 0 1 1 1 0 0 0)
      9.7982149124146 #(0 0 1 1 0 1 0 0 1 0 0 0 0 1 1 0 1 1 1 0 1 0 0 1 1 0 1 1 0 0 0 1 0 0 1 1 0 1 0 1 1 0 1 1 1 0 1 0 0 0 0 1 0 0 0 0 1 1 1 0 0 0)
 
-     8.595977 #(0.000000 0.295328 0.593237 0.627068 1.383238 0.327089 1.170065 0.728784 1.965246 1.042408 -0.108815 0.319112 0.945068 0.994594 1.758716 1.186938 1.316731 0.746287 1.405005 1.638800 0.701271 1.499510 1.297763 0.605052 1.177106 1.530682 1.073719 0.465939 0.792493 1.188955 0.658410 1.450829 0.740851 0.203195 0.862499 1.496192 0.941309 1.040749 -0.265198 0.228228 1.684628 0.372716 1.780951 1.680661 1.101493 1.805218 1.098221 0.939063 0.863124 0.368482 0.398588 0.260769 0.979797 0.362514 1.125011 1.052418 0.279774 -0.129295 1.586136 1.190797 1.170663 0.371734)
+     8.677814 #(0.000000 0.189840 0.385595 1.185970 1.126704 1.506578 0.265963 0.037265 1.926117 0.147710 0.214906 0.258267 0.077597 1.593580 1.440629 1.143272 1.160970 1.010793 1.426129 1.257471 1.214077 0.645157 0.675352 1.720518 1.071920 1.538459 1.291887 0.196285 1.350248 0.371365 0.088465 0.914582 1.713198 0.360211 1.695804 0.995401 0.595635 1.818555 1.254613 0.921638 0.155298 0.427511 0.396689 0.996661 0.676401 1.464607 0.409999 1.002145 0.211373 0.519859 -0.115513 1.267390 0.723833 0.764147 1.235503 0.163703 0.067211 0.849271 0.053034 0.898590 1.055778 0.929436)
      )
 
 ;;; 63 odd --------------------------------------------------------------------------------
@@ -1936,13 +1936,13 @@
 #(65 10.517309434908 #(0 1 1 1 0 1 1 0 1 0 1 1 0 1 1 0 1 1 1 1 1 0 1 0 1 1 1 0 1 1 0 1 0 1 0 1 1 0 0 0 0 0 1 1 0 0 0 0 1 1 0 0 1 1 1 1 1 1 0 0 0 0 1 0 1)
      10.169842720032 #(0 0 1 1 0 0 1 0 1 0 1 1 0 1 1 0 1 1 1 1 1 0 1 0 1 1 1 0 1 1 0 1 0 1 0 1 1 1 1 1 0 0 1 1 0 0 0 0 1 1 0 0 1 1 1 1 1 1 0 0 0 0 1 0 1)
 
-     8.728273 #(0.000000 1.599155 1.315802 1.738591 1.518083 1.052343 0.015249 1.179692 0.074835 1.547791 1.251721 0.496487 0.133790 0.466242 0.560178 1.585779 1.738813 1.947080 0.517748 0.480610 1.899937 -0.001472 1.639002 1.126191 1.378153 1.497592 0.407319 1.526096 0.677599 1.249992 1.971200 -0.022486 -0.197849 0.340368 1.598425 1.544789 1.333371 1.360476 1.538103 1.929489 1.078364 0.323283 0.331954 0.065419 0.778257 1.009866 1.153485 0.827921 0.946142 1.604659 0.126633 0.818268 1.655143 1.411520 0.810510 1.904843 1.939818 0.849300 0.497798 1.573872 0.159285 1.220815 0.431905 1.077673 0.765349)
+     8.858397 #(0.000000 1.592903 1.323507 1.734928 1.515666 1.031073 0.009644 1.175671 0.068614 1.570348 1.249652 0.498259 0.156470 0.463624 0.564907 1.581342 1.737144 1.941631 0.525966 0.474431 1.899858 -0.024367 1.654621 1.112866 1.387124 1.520628 0.409068 1.525031 0.663974 1.250487 1.962490 -0.022702 -0.183594 0.341506 1.590396 1.555614 1.317931 1.383265 1.540175 1.912654 1.083724 0.322911 0.326674 0.062660 0.791000 1.014933 1.135878 0.837972 0.943423 1.602174 0.124714 0.831767 1.680138 1.407742 0.821037 1.897371 1.937562 0.842678 0.481806 1.570615 0.144280 1.228481 0.431982 1.081859 0.755244)
      )
 
 ;;; 66 odd --------------------------------------------------------------------------------
 #(66 10.212840820553 #(0 0 0 0 0 1 1 1 1 0 0 0 1 1 0 1 0 0 1 0 0 1 1 1 1 0 0 1 1 1 0 0 1 1 0 1 1 0 0 0 1 0 1 0 0 0 1 0 1 0 1 0 1 1 0 1 0 0 0 0 0 0 0 0 1 0)
 
-     9.090910 #(0.000000 0.674830 1.634207 1.891202 0.439424 1.416595 0.422339 -0.206004 0.937441 0.535376 0.070787 1.594634 0.790306 1.538511 0.184780 1.753655 1.863121 1.511627 1.562818 1.164045 0.595202 1.715008 1.678251 -0.118187 1.060203 0.099673 0.865860 0.914708 1.581063 1.642997 1.116576 1.227335 0.685348 1.087105 0.048615 0.106041 0.337541 1.337640 1.681726 1.097279 1.631742 1.216142 0.635459 0.376132 1.188709 1.415158 1.181256 1.505730 0.257858 1.849359 0.684108 0.882985 -0.126904 0.110714 1.346726 1.625337 1.477873 1.651576 -0.043231 0.975408 0.401841 1.825506 0.184666 0.654135 0.469215 0.514990)
+     9.205235 #(0.000000 1.189446 0.913509 -0.112404 1.380527 -0.183888 0.481580 1.246700 1.221491 0.704956 0.760611 0.029912 1.031989 1.414746 -0.267627 0.109261 -0.003092 1.393504 1.022513 1.601527 1.177547 1.204352 0.390903 -0.253174 1.343197 -0.110063 0.892284 -0.129778 1.467220 1.180080 0.240805 0.240581 1.693974 1.274107 -0.156724 1.161380 0.865463 1.196976 -0.102628 0.877138 0.262293 1.766979 0.028656 0.955954 1.101265 0.180937 1.138221 1.068304 0.857247 1.109263 0.803361 1.695915 1.029026 1.528333 0.293036 0.154490 0.090477 0.506478 1.469943 -0.086406 0.098531 0.311105 0.340124 -0.062814 0.780411 1.571908)
      )
 
 ;;; 67 odd --------------------------------------------------------------------------------
@@ -1973,7 +1973,7 @@
 #(70 11.087729454041 #(0 1 0 0 0 0 1 1 1 1 0 0 1 0 1 0 0 1 1 0 1 0 1 0 0 1 0 0 0 1 1 1 1 0 1 1 0 1 1 1 0 0 0 1 0 0 1 1 0 1 1 0 1 1 0 0 0 1 0 1 0 1 1 1 1 1 1 0 1 1)
      10.431521047498 #(0 1 0 0 0 0 1 1 1 1 0 0 1 0 1 0 0 1 1 0 1 0 1 1 0 1 0 0 0 1 1 1 1 0 1 0 0 1 1 1 0 0 0 1 0 0 1 1 0 1 1 0 0 1 0 0 0 1 0 1 0 1 1 1 1 1 1 1 1 1)
 
-     9.218593 #(0.000000 1.050690 0.468476 -0.293964 0.283493 0.879027 1.176651 -0.045416 1.698969 1.376508 1.502750 0.083435 -0.058507 1.050830 0.011803 -0.265756 0.422955 0.235956 0.837814 -0.025677 -0.008622 0.518557 0.755528 0.967694 0.870120 -0.496392 0.938516 0.565634 0.557559 -0.443604 0.350299 0.635570 0.282906 1.553324 1.406026 1.353377 -0.211900 1.161154 0.508168 0.611374 1.352347 0.896322 1.400561 1.765240 0.420337 1.638975 0.450456 1.345850 0.047547 1.220996 0.595149 0.237587 1.120158 1.248397 0.867999 1.462286 -0.571284 -0.307696 1.225804 0.987791 0.759563 0.760423 -0.031919 1.032400 1.350865 0.979706 1.033665 1.231636 0.221179 0.612470)
+     9.283930 #(0.000000 1.047760 0.469941 -0.296016 0.273683 0.867206 1.184215 -0.047347 1.705923 1.375476 1.495039 0.085423 -0.055294 1.055473 0.016668 -0.265476 0.426377 0.242369 0.835485 -0.029426 -0.018484 0.522931 0.752743 0.966288 0.869195 -0.501207 0.924340 0.557306 0.562417 -0.445667 0.351050 0.639927 0.278573 1.544020 1.418426 1.350742 -0.209951 1.170270 0.504501 0.603402 1.361745 0.895921 1.395323 1.777670 0.429716 1.625377 0.444662 1.343709 0.044545 1.218155 0.590155 0.229089 1.118137 1.252634 0.879383 1.464610 -0.576715 -0.305326 1.227535 0.981855 0.767202 0.760430 -0.034108 1.032698 1.354029 0.988525 1.036237 1.233128 0.225462 0.615253)
      )
 
 ;;; 71 odd --------------------------------------------------------------------------------
@@ -1989,7 +1989,7 @@
      10.912703440154 #(0 0 1 1 0 1 0 1 0 0 0 0 0 0 0 0 1 1 0 1 0 0 0 0 0 1 0 0 1 1 0 1 0 1 0 1 0 0 1 1 1 0 0 1 1 0 0 1 0 0 1 0 0 0 0 0 1 0 1 0 1 0 0 1 1 1 1 1 0 0 0 1)
      10.880306243896 #(0 0 1 0 0 1 0 1 0 0 0 0 0 0 0 1 1 0 0 1 0 0 0 0 1 1 0 0 1 1 0 1 0 1 0 1 0 1 1 1 1 0 0 1 1 0 0 0 0 0 1 0 0 1 0 0 1 0 1 0 1 1 0 1 1 1 0 0 0 0 0 1)
 
-     9.421413 #(0.000000 0.510075 0.417037 1.401953 1.445508 1.253897 0.128498 0.669245 1.774732 0.074192 0.703334 0.167204 -0.080635 0.237020 1.358633 0.941282 1.672199 0.792938 0.778230 1.238515 0.362959 0.219653 1.358301 1.449674 0.866924 1.420353 1.765635 0.601111 -0.138618 1.897150 1.681540 0.434230 0.580238 0.626829 0.802747 0.386531 0.573849 1.559359 0.784216 1.678779 1.613203 0.689591 0.219698 1.280853 1.125064 1.120507 1.094360 1.068171 1.266310 1.209645 -0.054856 0.839332 1.158633 0.954943 0.707537 1.360360 -0.136894 0.836587 0.200035 0.587721 0.881310 1.528416 1.520049 1.557296 0.711125 1.350271 0.438116 1.642225 1.317986 0.478714 0.600181 0.257995)
+     9.438569 #(0.000000 0.098430 0.564296 0.058636 0.062891 0.718816 0.980145 -0.144075 0.681245 1.248582 1.172050 1.345829 1.632168 0.912157 -0.010905 0.892062 1.753084 0.362278 1.405984 -1.818053 0.381116 1.849169 0.487644 1.446994 -0.122060 0.233824 0.763595 1.609740 0.937045 1.766299 -0.098292 1.484433 1.620879 0.885186 0.398652 0.211689 0.036267 0.876333 0.575764 0.209031 1.694153 1.741831 1.806304 1.678190 0.748680 0.477816 1.010738 0.101512 1.661165 0.011219 1.552424 0.459119 1.045302 1.469352 1.449813 0.459457 1.423254 1.876528 1.030036 0.412386 0.822863 0.682689 1.231748 0.301558 0.136055 0.998293 0.542091 1.131603 0.577470 0.146040 0.792137 0.380247)
      )
 
 ;;; 73 odd --------------------------------------------------------------------------------
@@ -2004,7 +2004,7 @@
      11.288741871055 #(0 0 1 0 1 1 1 1 1 1 1 1 1 1 1 0 1 1 0 0 0 1 0 1 1 0 1 1 1 1 1 0 1 1 1 1 0 0 0 0 1 1 0 0 1 0 1 1 1 0 1 1 0 0 0 1 1 1 0 1 1 1 0 0 1 0 0 1 1 1 1 0 1 0)
      11.262331896     #(0 0 1 1 1 0 0 1 1 0 0 1 0 1 1 0 1 1 0 1 0 1 1 0 1 1 0 0 0 0 0 0 1 0 0 1 1 1 0 0 1 1 1 0 0 0 0 1 1 1 1 0 1 0 0 0 0 1 0 1 0 1 0 1 1 1 1 0 1 0 0 1 1 0)
 
-     9.652488 #(0.000000 1.802421 0.625206 0.231424 1.825478 1.593704 0.881961 1.169312 0.633386 1.647134 0.529058 1.644023 0.938506 0.035152 1.635537 1.728626 1.426138 0.700230 0.265794 0.540003 1.221697 1.453469 0.052025 -0.057169 1.368740 1.079098 1.454841 0.704316 1.121732 0.130302 1.538813 0.430196 1.460014 0.707514 1.499043 1.146605 0.740373 1.520409 1.250958 1.350833 1.242578 0.944536 1.559037 1.127904 0.466058 0.203660 1.292066 0.713148 1.428058 1.866027 0.741311 0.458100 0.599152 0.937816 1.909047 0.908849 0.983541 1.640429 1.851409 1.654908 1.534914 1.815037 1.114036 1.407737 0.193247 0.696379 1.351493 1.646391 0.739602 0.108394 0.507335 0.236591 0.248688 1.524301)
+     9.670091 #(0.000000 1.800936 0.628340 0.231413 1.822531 1.596013 0.885408 1.173288 0.632913 1.646720 0.532815 1.644623 0.936045 0.036252 1.637494 1.729209 1.423845 0.700844 0.261318 0.538441 1.221632 1.460445 0.051506 -0.057580 1.364937 1.079030 1.455391 0.707096 1.121577 0.131596 1.541438 0.432591 1.461539 0.710587 1.501728 1.147931 0.738250 1.514629 1.255251 1.351824 1.239677 0.948134 1.562809 1.127061 0.465588 0.202457 1.290277 0.717306 1.427413 1.866456 0.737728 0.456278 0.598735 0.935344 1.912981 0.909019 0.977931 1.638101 1.852665 1.655993 1.531903 1.816493 1.112402 1.409738 0.194357 0.701326 1.354209 1.646197 0.741864 0.104130 0.509110 0.235617 0.249549 1.526519)
      )
 
 ;;; 75 odd --------------------------------------------------------------------------------
@@ -2020,7 +2020,7 @@
      11.446428749262 #(0 0 1 1 0 0 0 1 0 0 1 1 1 1 1 0 1 0 1 1 0 0 0 0 0 1 1 1 0 0 0 1 1 0 0 0 0 1 1 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 1 0 1 1 0 1 0 0 1 0 1 0 1 1 1 0 1 1 0 0 0 0)
      11.21743106842 #(0 0 1 1 0 0 0 1 0 1 1 1 1 1 1 1 1 0 1 1 0 0 0 1 0 1 1 1 0 0 0 1 1 0 0 0 0 1 1 0 0 1 0 0 0 0 0 1 0 1 0 0 0 0 1 0 1 1 0 1 0 0 1 0 1 0 1 1 1 0 0 0 0 0 0 0)
 
-     9.822339 #(0.000000 1.769818 0.477305 0.975639 0.389648 1.101852 0.968251 1.447194 0.898911 1.057978 0.576315 0.730683 0.154112 1.749570 1.454203 0.545052 0.671961 0.819581 1.887442 1.032058 0.029430 1.185844 0.532292 0.027507 0.620623 0.096566 1.634684 1.636069 0.563742 1.688229 0.690775 1.141547 0.913435 1.391557 1.240779 0.663012 1.201580 1.651198 1.173875 1.219994 1.309793 1.614426 1.078320 1.635167 0.331989 0.185196 1.040312 0.800195 0.193312 1.227214 1.634485 1.738656 1.586644 1.188758 0.828846 1.256368 0.598755 1.767615 0.619334 0.964424 0.196678 0.806901 1.228953 1.446017 0.445748 0.718421 0.040422 1.530121 1.667041 0.406475 0.766079 1.022844 1.413806 0.756735 0.563715 0.109635)
+     9.919235 #(0.000000 1.382592 1.761073 0.862136 1.636177 -0.315510 1.702518 0.348424 0.772227 1.501862 0.714521 0.227045 0.885826 1.583330 1.119403 0.316122 1.111695 1.688999 0.161809 0.592002 1.375725 0.166408 0.076747 0.057260 1.003556 0.126496 -0.136573 1.616594 0.287745 0.377783 1.804384 1.632796 1.784130 0.603914 1.418243 1.797139 1.062032 0.503693 0.168301 0.523158 0.290061 0.477039 0.523230 0.283666 1.133623 1.398589 1.129410 0.817249 1.678928 0.461189 0.104266 1.908672 0.742100 0.606798 1.596295 1.504470 1.822303 -0.187707 0.006229 1.250631 1.188249 -0.063911 1.094834 1.704632 0.231783 0.247962 0.611997 0.024993 1.426344 1.282784 0.182573 0.822043 0.360168 1.787535 1.730846 -0.340401)
      )
 
 ;;; 77 odd --------------------------------------------------------------------------------
@@ -2390,7 +2390,7 @@
       14.561 #(0 0 1 0 1 1 0 1 0 0 0 0 1 1 1 1 0 0 1 0 1 0 0 1 1 0 1 0 0 0 0 0 1 1 1 0 1 0 0 1 0 0 0 1 1 0 0 1 0 1 1 1 1 0 0 1 1 0 0 0 1 0 1 0 1 0 0 1 1 1 1 0 1 0 0 0 0 0 1 0 1 0 0 1 1 0 0 1 0 1 1 0 0 1 1 1 0 0 0 0 0 0 1 0 0 0 0 1 0 1 0 0 0 0 0 0 1 1 0 1 1 1)
       14.266534958875 #(0 0 1 0 1 1 0 1 0 0 0 0 1 1 1 1 0 0 1 1 1 0 0 1 1 0 1 0 0 0 0 0 1 1 0 0 1 0 0 1 0 0 0 1 1 0 0 1 0 1 1 1 1 0 1 1 1 0 0 0 1 0 1 0 1 0 0 1 1 1 1 0 1 0 0 0 0 0 1 0 1 0 0 1 1 0 0 1 0 1 1 0 0 1 1 1 0 0 0 0 0 0 1 0 0 0 0 1 0 1 0 0 0 0 0 0 1 1 0 1 0 1)
 
-      13.244458 #(0.000000 0.514241 1.100611 1.496421 0.149101 0.158321 1.360184 0.122717 1.589963 1.760561 0.177672 0.537562 1.320973 1.913169 1.862946 0.675826 1.248856 0.915830 1.600646 0.495244 1.502456 0.929928 0.933708 1.286768 1.377040 1.472391 0.374066 -0.004608 0.331518 0.300646 1.607896 0.818094 0.773044 1.074181 -0.145016 0.720730 1.173293 0.347385 1.644872 0.702944 0.797357 0.755667 0.335099 0.741809 0.135255 0.132909 0.451825 0.548653 1.441879 1.315983 0.769130 0.230471 0.144278 1.772844 0.713627 0.965971 1.764582 0.629107 0.004270 0.842255 0.683541 0.942188 0.590471 1.480290 0.289716 0.341525 -0.048816 0.808164 0.754091 1.089282 0.512007 0.588128 1.709111 0.103642 1.425364 0.634540 1.326675 1.351273 1.122354 0.709970 1.394287 1.324717 0.516489 0.049562 0.771770 1.451178 1.232426 1.250906 1.738351 1.741486 1.396555 1.098587 0.077810 -0.053849 0.390255 0.946563 1.926796 0.022054 0.889535 1.923993 0.911294 1.944730 0.965063 0.730254 0.860358 0.709177 0.031533 0.898794 0.492550 1.791732 1.426368 1.192384 0.246386 1.065725 0.171128 -0.058859 1.147516 0.707899 0.592457 0.724861 0.338549 1.348348)
+      13.289994 #(0.000000 1.465424 1.527733 0.003901 1.190143 1.412601 0.025896 0.594764 1.762403 0.851122 0.648403 1.507066 0.388526 0.625823 0.440610 0.891355 -0.010506 1.818306 1.700046 1.229871 0.074227 0.737946 0.628844 0.601673 0.586374 0.968083 -0.132859 0.318431 0.423604 0.330383 1.273025 -0.006679 1.268813 1.318094 1.144734 0.937627 1.487931 0.493260 1.323306 1.026789 0.922416 1.274546 1.623041 1.653693 0.693822 0.322657 1.350106 1.210087 1.493417 0.313226 1.418963 1.038997 0.640663 0.033394 0.540040 1.362947 1.607055 1.155580 0.069927 1.191931 1.221439 0.151650 0.169266 0.015313 0.612570 1.867524 0.209668 1.820895 0.903466 0.723241 0.103088 0.182112 0.064988 1.237966 -0.141291 1.992102 1.735861 1.972671 -0.141676 0.873820 0.539665 1.729975 1.475489 1.097648 0.742561 1.556820 1.750776 1.555793 1.902691 0.201108 1.550840 0.181839 0.189849 1.369876 0.865428 1.146114 0.603534 -0.318007 0.267509 0.229537 1.600650 1.134701 0.687954 1.323894 0.080945 0.493703 1.346573 1.839947 0.983988 -0.105263 1.176464 0.158994 1.248777 1.389433 1.146112 0.325593 1.104562 0.456982 0.523305 1.363750 0.607887 1.701534)
       )
 
 ;;; 123 odd --------------------------------------------------------------------------------
@@ -2893,7 +2893,7 @@
 ;;; 51 prime --------------------------------------------------------------------------------
 #(51 10.5841327092253 #(0 1 0 0 0 1 0 0 0 0 0 1 1 0 0 1 0 1 1 1 1 0 0 0 0 0 0 1 1 0 1 1 0 0 0 1 0 1 0 0 1 0 0 1 0 0 0 1 0 0 1)
 
-     9.489692 #(0.000000 0.820340 0.325509 0.969297 1.080297 1.568974 0.754741 0.418487 0.745747 0.477418 0.773112 0.039462 1.085499 0.363860 1.537790 0.958479 1.166501 0.231522 0.790674 1.097897 0.750496 1.254641 0.825676 0.201458 0.226928 1.385936 0.698217 0.116378 0.207092 1.809660 0.779129 1.202688 0.167317 1.451570 1.581661 1.094791 0.932656 0.774092 1.778077 -0.200167 1.689675 -0.035625 0.279673 -0.115807 0.865562 0.801018 -0.223585 1.078942 0.570556 0.659282 1.393893)
+     9.500245 #(0.000000 0.822222 0.330685 0.971677 1.080800 1.567673 0.757622 0.416282 0.746054 0.477179 0.773053 0.044236 1.083973 0.362276 1.537516 0.959234 1.169569 0.232711 0.791027 1.098627 0.754696 1.248583 0.826248 0.201931 0.224660 1.382599 0.699995 0.117764 0.205182 1.808544 0.777265 1.201671 0.171531 1.449287 1.582507 1.091775 0.935283 0.772608 1.782596 -0.201122 1.687301 -0.043451 0.279363 -0.113696 0.862172 0.800043 -0.218134 1.080335 0.569076 0.658678 1.390098)
      )
 
 ;;; 52 prime --------------------------------------------------------------------------------
@@ -3249,7 +3249,7 @@
      15.438541412354 #(0 0 0 1 0 0 1 1 0 0 1 1 0 0 0 1 1 1 1 0 0 1 0 1 1 1 0 0 0 1 0 0 0 0 0 1 1 1 1 1 1 1 0 1 0 1 1 0 0 0 0 0 0 0 0 1 1 1 1 0 0 1 1 1 0 1 1 1 0 1 1 0 0 1 1 0 0 0 0 0 1 1 0 0 0 1 0 0 0 0 1 0 0 0)
      14.811392756555 #(0 0 0 1 0 0 1 0 0 0 1 1 0 0 1 1 1 1 1 0 0 1 0 1 0 1 1 0 1 1 0 0 0 1 0 1 1 1 1 1 1 1 0 1 1 1 0 0 0 0 1 0 0 0 0 1 1 1 0 0 0 1 1 0 0 1 0 1 0 1 1 0 0 1 1 0 0 0 0 0 1 1 0 0 0 1 0 0 0 0 1 0 0 0)
 
-     13.707853 #(0.000000 1.373831 0.925177 0.544823 0.883272 1.248347 1.211280 0.062946 0.595695 0.993038 0.083367 0.296709 1.223008 1.280516 1.635845 1.650305 0.632255 0.676776 0.801318 0.843537 0.999191 1.881667 -0.142071 1.425982 0.726992 0.473761 1.377148 1.075668 1.943613 0.366244 0.715926 1.748669 1.475095 0.830018 0.902143 1.429603 1.699984 1.856653 0.546547 1.048692 0.854351 0.090750 0.639850 0.841076 1.638855 1.466421 1.165293 1.438354 -0.231900 0.114604 1.447761 1.061869 0.612688 0.248986 1.615254 -0.171428 1.277518 0.034057 1.765611 0.294166 1.811888 1.765472 0.992692 1.382672 1.066624 0.961836 0.921381 0.328506 1.527690 0.247955 1.468225 1.259861 1.744284 1.080855 0.494175 0.860241 0.635002 1.599792 0.509623 1.564949 1.547338 1.196172 1.938463 1.909435 0.454473 0.349616 0.211845 1.130779 0.625056 1.607999 0.606058 1.806860 1.122366 0.801222)
+     13.723886 #(0.000000 1.375743 0.922963 0.543234 0.882876 1.247622 1.214106 0.064906 0.599044 0.994383 0.083958 0.296342 1.219750 1.277536 1.634137 1.650672 0.631233 0.673351 0.802198 0.842688 1.000800 1.882046 -0.139227 1.427219 0.728778 0.472327 1.378345 1.077310 1.939747 0.364364 0.719213 1.748582 1.471548 0.832812 0.902323 1.428668 1.695412 1.852955 0.545797 1.049336 0.853890 0.088989 0.642552 0.835922 1.636219 1.463560 1.162994 1.437991 -0.231455 0.114735 1.446536 1.057672 0.613611 0.250608 1.613480 -0.167560 1.274641 0.030497 1.764800 0.295996 1.809159 1.767356 0.991743 1.380303 1.069162 0.959951 0.923301 0.327828 1.527287 0.249273 1.476038 1.260704 1.742161 1.077940 0.493449 0.856602 0.632705 1.602236 0.512710 1.564055 1.541852 1.196160 1.938251 1.911075 0.453809 0.348139 0.210500 1.132279 0.623771 1.607677 0.608930 1.808004 1.124641 0.802152)
      )
 
 ;;; 95 prime --------------------------------------------------------------------------------
@@ -3266,7 +3266,7 @@
      15.281 #(0 1 1 0 1 0 1 1 0 0 1 0 0 0 1 1 1 1 0 0 1 1 0 1 1 0 1 0 1 1 0 0 0 0 1 1 1 0 0 0 0 1 1 0 1 1 0 0 0 0 0 0 1 0 1 0 0 1 1 0 0 0 1 1 0 0 1 1 1 0 1 1 1 1 1 1 1 1 0 0 1 0 1 0 1 0 1 1 1 1 1 1 0 0 1 0)
      15.135 #(0 1 1 0 1 0 1 1 0 0 0 0 0 0 1 1 1 1 0 0 1 1 0 1 1 0 0 0 1 1 0 0 0 1 1 1 1 0 0 0 0 1 1 0 1 1 0 0 0 0 0 0 1 0 1 0 0 1 1 0 0 0 1 1 0 0 1 1 1 0 1 1 1 1 1 1 1 1 0 1 1 0 1 0 1 0 1 1 1 1 1 1 0 0 1 0)
 
-     13.716084 #(0.000000 1.133745 1.283229 1.413127 1.729167 0.001159 1.324857 1.730305 0.802018 0.881226 0.312120 0.894288 0.232195 0.671517 0.016720 1.145273 1.291970 0.938935 0.153891 0.414152 0.206419 1.268594 1.826925 0.554732 1.165847 0.968303 0.237140 0.684516 1.023612 0.538052 0.131378 0.984469 1.089059 1.575874 -0.133704 0.459707 1.250946 1.336265 0.635696 1.507468 0.230761 -0.105791 0.210889 0.879542 1.789728 1.161070 0.523793 0.146620 1.995969 0.898751 1.807801 -0.114611 0.475489 0.193588 1.910741 0.076302 0.336584 1.595966 1.429694 1.446788 1.020687 0.824638 1.141474 1.029942 1.240577 1.767592 1.135449 1.069548 1.203292 1.477317 -0.036760 0.736765 1.418078 1.478815 0.659090 1.854812 1.160771 1.028766 0.674202 1.334854 0.117927 1.488248 0.647826 1.486771 1.342508 1.765181 1.311916 0.781825 0.063758 -0.121904 1.414223 1.404385 1.964153 1.203290 0.236221 0.745718)
+     13.798322 #(0.000000 1.142154 1.280994 1.416348 1.729593 1.996876 1.320633 1.726078 0.802046 0.882640 0.309171 0.894127 0.221387 0.675029 0.008668 1.146111 1.296798 0.938656 0.153226 0.399811 0.198442 1.266405 1.833115 0.557529 1.161638 0.963096 0.234893 0.688336 1.025506 0.543955 0.140640 0.977597 1.088780 1.584275 -0.127480 0.462752 1.249170 1.333455 0.637970 1.510673 0.224688 -0.110553 0.206468 0.884806 1.793723 1.166886 0.522602 0.152539 1.987318 0.914301 1.811482 -0.111372 0.482369 0.202872 1.907787 0.075610 0.326264 1.583721 1.431252 1.450975 1.029061 0.815724 1.145362 1.024120 1.253066 1.776669 1.130969 1.062957 1.196199 1.474646 -0.039674 0.742493 1.416432 1.478977 0.660378 1.848723 1.153749 1.028124 0.677563 1.338034 0.121904 1.483956 0.643943 1.488807 1.348789 1.763560 1.318450 0.775224 0.063075 -0.122817 1.415146 1.409461 1.960973 1.207379 0.237868 0.748237)
      )
 
 ;;; 97 prime --------------------------------------------------------------------------------
@@ -3377,7 +3377,7 @@
       16.799713998439 #(0 1 1 0 1 1 1 1 1 0 0 0 0 0 0 1 0 1 0 0 0 1 1 1 0 0 1 1 1 0 0 0 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 0 1 0 1 0 1 0 1 0 0 1 1 0 1 1 0 1 1 0 1 0 0 0 0 0 1 0 0 1 1 1 0 1 0 1 1 1 0 0 1 1 0 1 0 1 0 1 1 0 1 0 1 1 1 0 1 0 1 1 1 1 1)
       16.455888332339 #(0 1 1 0 1 1 1 1 1 0 0 1 0 0 0 0 0 1 0 0 0 1 1 1 0 0 1 1 1 0 0 0 1 1 1 1 1 1 1 1 1 1 1 0 1 1 1 1 0 1 0 1 0 1 0 1 1 0 1 1 0 1 1 0 1 1 0 1 0 0 0 0 0 1 0 0 1 0 0 0 1 0 1 0 1 0 0 1 1 0 1 0 1 0 1 1 0 1 0 1 1 0 0 1 0 0 1 1 1 1)
 
-      15.300781 #(0.000000 0.326383 0.191870 1.005079 1.442940 1.065991 -0.158260 1.147225 0.344249 0.112973 1.479034 1.337801 -0.579523 -0.029617 0.224406 0.939377 1.084571 -0.010319 1.662103 1.505797 0.040421 1.574808 0.005623 0.271403 0.389730 0.844152 1.510146 0.572591 1.653125 0.706660 1.362766 0.376209 1.272523 1.403014 0.540529 0.333317 0.396173 1.173279 0.606601 0.863811 -0.081739 0.776356 1.804589 1.470428 -0.388572 1.400331 0.231132 0.608251 1.716398 1.376944 0.194532 1.501304 0.536643 0.302741 0.010698 1.474233 1.322277 1.396666 0.589718 1.545295 1.112602 1.509551 0.843550 0.909042 1.812292 0.864852 0.946385 0.981252 0.028397 0.486478 1.805402 0.201652 0.429254 -0.013975 0.524679 1.609869 0.281082 0.708354 0.931046 0.908423 0.194177 0.779179 1.146017 1.332176 1.447515 1.278089 0.867395 1.419271 0.944456 0.494207 0.809763 -0.116867 1.094687 0.418903 0.505121 1.043216 1.604069 0.667740 1.615320 1.633384 0.949891 0.704008 0.949960 0.828345 -0.280681 0.720978 0.335148 -0.080915 1.066965 0.473199)
+      15.321829 #(0.000000 0.328551 0.193949 1.007585 1.444727 1.064456 -0.158692 1.146227 0.343112 0.115129 1.479297 1.333037 -0.577998 -0.025266 0.223774 0.940665 1.085478 -0.011854 1.665080 1.506168 0.042199 1.578046 0.005427 0.273383 0.388047 0.845575 1.508426 0.572351 1.656203 0.711409 1.363929 0.377946 1.270794 1.406823 0.536314 0.333833 0.396674 1.176770 0.600649 0.864895 -0.079678 0.778909 1.802894 1.470271 -0.388639 1.400344 0.232393 0.606739 1.716003 1.375879 0.194519 1.499670 0.537476 0.301000 0.008902 1.471172 1.318749 1.393963 0.590671 1.545256 1.110105 1.509067 0.847310 0.910068 1.809678 0.865090 0.944831 0.983329 0.027244 0.485350 1.805090 0.198173 0.427504 -0.015654 0.527144 1.608441 0.281727 0.708521 0.935558 0.904870 0.190835 0.781455 1.145926 1.337208 1.447826 1.279536 0.867312 1.420932 0.943370 0.497911 0.810980 -0.116260 1.094849 0.421818 0.506754 1.041154 1.603610 0.668017 1.616827 1.633722 0.949078 0.703396 0.946784 0.827883 -0.281375 0.718420 0.337366 -0.078939 1.066269 0.470445)
       )
 
 ;;; 111 prime --------------------------------------------------------------------------------
@@ -3454,7 +3454,7 @@
       17.540792728815 #(0 0 0 1 1 1 0 1 0 0 0 0 0 1 0 0 0 0 0 1 1 1 1 1 0 1 1 1 1 1 0 0 1 1 1 1 0 1 1 1 1 1 1 0 0 0 1 1 1 1 1 1 0 0 1 0 0 1 1 0 1 1 1 1 1 0 0 0 0 1 1 1 1 0 0 1 0 1 1 0 1 0 0 1 0 0 1 1 1 1 1 0 0 0 1 1 0 0 0 1 0 0 0 0 1 1 0 0 0 1 1 0 1 1 0 1 0 1 1 0)
       17.067 #(0 1 0 1 1 1 0 1 0 0 1 0 0 1 0 0 0 0 0 1 1 1 0 1 0 1 0 1 1 1 0 0 1 1 1 1 0 1 1 1 0 1 0 1 0 1 0 1 1 1 1 1 1 0 1 0 1 1 1 0 1 1 0 1 1 0 0 0 0 1 1 1 1 0 0 1 0 1 1 0 1 0 1 1 0 0 1 1 1 1 1 1 0 0 1 1 0 0 0 1 0 0 0 0 1 0 0 0 0 1 1 0 1 1 0 1 0 0 1 0)
 
-      16.100643 #(0.000000 1.857705 0.123925 0.824729 0.068946 1.056330 1.701837 1.293616 1.243104 0.832417 1.659245 0.048057 -0.006881 1.261793 1.179562 1.945522 1.151415 0.664492 1.377107 0.118530 0.784143 0.308117 0.935313 1.145544 1.322495 0.149351 0.919926 1.331399 0.707034 0.132322 1.023535 0.362831 0.088730 -0.137290 1.279756 1.922901 0.913698 0.566778 1.450330 0.915171 -0.167955 1.260136 1.687431 0.108450 0.954883 1.609808 1.004171 1.494691 0.878047 1.069292 0.860801 1.457194 0.249561 1.762634 1.693751 0.370185 0.114586 1.012904 1.017852 1.730438 1.108737 1.536111 0.006783 0.150172 1.334586 0.373934 0.115006 0.769277 1.248266 0.191222 0.754783 0.421002 1.309610 0.239771 1.748284 0.030327 1.737817 1.421719 1.616497 0.091677 0.051880 0.128396 0.797589 1.294897 0.746909 1.386034 0.375053 1.058915 0.485445 0.373879 1.288069 1.970248 0.033859 1.450699 0.024159 0.194359 -0.017365 0.887055 0.273365 1.583203 0.400306 0.937282 -0.079487 1.699435 1.356678 1.600030 0.787334 0.359565 1.604403 1.084542 1.580913 1.008932 1.265274 0.962378 -0.012530 0.126460 -0.156073 1.171007 1.566597 0.508379)
+      16.122543 #(0.000000 1.859747 0.125946 0.822874 0.072115 1.057777 1.699568 1.290751 1.238945 0.835011 1.661291 0.050538 -0.007239 1.265525 1.176903 1.946720 1.150633 0.666565 1.375475 0.117346 0.784349 0.301881 0.934171 1.143639 1.322071 0.152709 0.919533 1.334645 0.708509 0.139104 1.025611 0.360481 0.091302 -0.135488 1.279235 1.921980 0.914602 0.564775 1.449710 0.913582 -0.165743 1.260361 1.687219 0.104299 0.958677 1.617396 1.002921 1.497333 0.877887 1.071203 0.860240 1.455497 0.253848 1.764336 1.690509 0.367511 0.113735 1.012525 1.015277 1.727846 1.109108 1.533565 0.004355 0.147337 1.333757 0.372513 0.116841 0.770629 1.245144 0.193153 0.756735 0.422583 1.310894 0.239250 1.743137 0.028868 1.734299 1.420905 1.616751 0.091390 0.050091 0.127880 0.801343 1.295493 0.747610 1.389274 0.372478 1.058335 0.484461 0.371106 1.285977 1.967611 0.034757 1.447786 0.026166 0.194637 -0.019255 0.884862 0.275145 1.585105 0.399586 0.934967 -0.082351 1.702018 1.356922 1.601825 0.781260 0.355059 1.602297 1.081505 1.584455 1.009283 1.262790 0.960605 -0.012530 0.125096 -0.156437 1.167825 1.569143 0.506693)
       )
 
 ;;; 121 prime --------------------------------------------------------------------------------
@@ -4306,7 +4306,7 @@
 #(86 13.114136440046 #(0 0 1 1 0 0 1 0 1 1 1 0 1 1 0 1 0 0 0 1 0 0 0 1 0 1 0 1 0 1 0 1 1 0 1 0 0 0 1 0 1 1 0 1 0 0 1 0 0 1 1 0 0 0 1 0 0 0 1 1 1 1 0 1 0 0 0 0 1 0 0 1 0 0 0 1 1 0 0 0 0 1 1 1 0 0)
      12.791990425787 #(0 0 1 1 0 0 1 0 1 1 1 0 1 1 0 0 0 0 0 1 0 0 0 1 0 1 0 1 0 1 0 1 1 0 1 0 0 0 1 0 0 1 0 1 0 0 1 0 0 1 1 0 0 0 1 0 0 0 1 1 1 1 1 1 0 0 0 0 1 0 0 1 0 0 0 1 1 0 0 0 0 1 1 1 0 0)
 
-     11.125345 #(0.000000 1.437862 0.637744 1.588643 1.366778 1.061150 1.101281 0.683731 1.078647 1.300105 0.608887 1.793701 0.520829 1.772560 1.562207 0.620191 1.863750 0.445830 0.056088 0.000863 0.762387 0.467879 0.945419 0.757438 1.292253 0.682710 0.313562 0.333963 1.490803 1.639020 1.534773 0.338938 1.145460 1.650086 0.911149 -0.111662 1.399203 0.910514 1.254496 0.052675 1.017063 1.177466 0.221441 0.141206 -0.187855 -0.059097 0.405699 1.453812 0.538929 0.041440 1.444400 0.486465 0.556947 -0.290109 1.542731 0.287562 1.634675 0.607396 0.656447 0.790762 1.247474 1.836970 0.353771 1.188250 0.127711 0.024457 0.262267 0.611231 1.112861 0.957296 0.882288 0.160866 0.309337 1.962278 -0.175598 1.901688 0.981298 0.065393 0.220175 0.120826 0.734289 0.963221 0.495620 0.576796 -0.137466 0.367088)
+     11.178906 #(0.000000 1.432476 0.642716 1.590278 1.363409 1.055340 1.107537 0.685072 1.082507 1.292678 0.604081 1.787353 0.515019 1.773816 1.571680 0.620472 1.861906 0.453355 0.055610 0.010318 0.768420 0.468648 0.938024 0.757183 1.292540 0.681343 0.311744 0.329806 1.483705 1.641258 1.535561 0.340480 1.145325 1.647819 0.907817 -0.118486 1.396235 0.905942 1.258936 0.041423 1.012698 1.179213 0.215457 0.145235 -0.192171 -0.059829 0.405741 1.458664 0.542432 0.039524 1.442497 0.481316 0.548617 -0.286357 1.540651 0.283483 1.634253 0.614448 0.656338 0.785378 1.254372 1.835818 0.348800 1.192005 0.125900 0.019713 0.269033 0.613716 1.113746 0.963700 0.879015 0.158905 0.308266 1.956289 -0.172828 1.902147 0.977598 0.072447 0.223736 0.114331 0.732967 0.963970 0.497517 0.581832 -0.139970 0.361214)
      )
 
 ;;; 87 even --------------------------------------------------------------------------------
@@ -4402,7 +4402,7 @@
      13.490633234777 #(0 1 1 0 1 1 0 0 1 1 0 1 1 1 0 1 0 1 1 0 1 1 0 1 0 0 0 0 1 1 1 0 1 1 0 1 0 0 0 1 0 1 0 1 0 1 0 0 0 0 0 0 0 1 1 1 1 0 0 1 1 1 1 0 1 0 1 1 1 1 1 0 0 1 1 1 1 0 1 1 0 0 0 1 1 0 1 0 1 1 0 1 1 1 0 1 1 1)
      13.468658765207 #(0 0 1 0 1 1 1 0 0 0 0 1 0 1 0 0 0 1 1 0 1 0 0 1 0 0 0 1 1 1 1 0 0 1 1 1 1 0 1 0 1 0 0 0 1 0 0 0 0 1 0 0 0 0 0 0 0 1 0 0 1 0 0 1 1 0 1 0 1 1 0 0 1 1 0 0 1 0 0 0 1 1 1 1 1 0 1 0 0 0 1 1 1 0 1 1 0 1)
 
-     11.855454 #(0.000000 1.835891 0.901583 0.083948 0.859233 1.270999 1.660854 1.208183 0.809432 0.346359 0.299155 0.867828 0.503140 0.988216 0.965411 0.186556 1.631402 0.800295 1.510276 -0.174956 1.511209 1.089959 0.638407 1.349218 -0.169632 0.741120 0.454371 -0.292937 1.738350 -0.049630 0.392416 0.850390 1.122445 1.283300 0.246522 1.129175 0.304520 1.161637 0.728095 1.226611 0.477532 1.043478 0.185335 0.019072 -0.080823 1.648662 0.367835 0.376391 0.941932 1.706200 0.045477 0.622148 1.369379 0.618102 1.844063 1.577467 -1.891968 1.412334 0.509792 0.174852 0.821398 0.988030 1.696872 1.012693 0.953733 0.504926 0.666484 0.447601 0.975478 1.622102 -0.026127 0.747278 1.449430 0.260188 0.559728 0.314779 0.902255 0.299640 0.888094 0.952530 0.771694 1.875020 0.265140 1.004229 0.701533 0.662427 0.356931 0.113891 0.196934 0.437819 0.333981 1.581820 1.437303 1.119440 1.366593 0.522367 0.278475 1.651580)
+     11.871695 #(0.000000 1.836972 0.903833 0.081914 0.857761 1.272181 1.660557 1.210593 0.807121 0.345394 0.299776 0.862752 0.501716 0.989184 0.964971 0.180079 1.630665 0.799493 1.508831 -0.175271 1.515178 1.086599 0.640145 1.349724 -0.167132 0.741639 0.455307 -0.294386 1.739815 -0.050744 0.399492 0.844409 1.123011 1.280343 0.249718 1.129905 0.304810 1.161638 0.725981 1.231151 0.477837 1.043462 0.182309 0.020790 -0.081952 1.647737 0.372078 0.374258 0.944524 1.706244 0.046512 0.621080 1.368183 0.619541 1.841581 1.578345 -1.890040 1.410319 0.505227 0.178440 0.815483 0.992395 1.694045 1.008234 0.951032 0.502373 0.669412 0.448444 0.977067 1.617109 -0.023325 0.750447 1.445702 0.260210 0.561365 0.312948 0.905044 0.298235 0.891503 0.955456 0.772045 1.875587 0.266105 1.000220 0.700276 0.659312 0.352891 0.108485 0.200509 0.436603 0.334741 1.580388 1.435614 1.120291 1.367757 0.523935 0.278847 1.652612)
      )
 
 ;;; 99 even --------------------------------------------------------------------------------
@@ -4564,7 +4564,7 @@
 #(119 15.519069915733 #(0 1 1 0 0 1 1 1 0 0 0 1 1 0 1 0 1 1 0 1 1 0 1 1 1 1 0 0 0 0 0 0 1 1 1 0 0 0 1 0 1 0 1 0 1 0 1 0 0 0 0 0 0 1 1 1 1 1 1 0 0 0 0 1 0 1 0 0 1 0 0 1 1 0 0 0 0 1 1 0 0 0 1 0 1 1 1 0 0 1 0 0 0 0 1 0 0 1 0 0 0 1 1 0 1 0 0 1 1 0 1 1 1 1 1 1 0 0 1)
       14.971 #(0 1 0 0 1 0 1 0 0 1 1 1 0 1 1 0 0 0 0 0 0 0 0 1 0 1 1 0 0 1 1 1 1 0 0 0 1 1 0 1 0 1 1 1 1 0 1 0 0 1 1 1 1 1 1 0 1 1 1 0 1 0 1 1 0 0 0 1 1 0 0 1 0 1 0 1 0 1 1 1 1 1 1 0 0 1 1 0 0 1 0 0 1 1 1 1 0 1 0 0 0 1 1 1 1 0 0 0 0 1 0 0 1 1 0 1 0 1 1)
 
-      13.544950 #(0.000000 0.443552 1.449439 1.507688 1.511684 1.131038 0.222307 0.330585 1.720102 0.102560 1.982424 0.791896 -0.056990 1.497392 0.602835 1.598465 0.633190 0.490967 1.525790 1.862857 0.515117 0.783964 1.850975 0.403561 0.511968 1.680562 1.556970 0.976889 1.126691 1.225564 0.037794 -0.033638 0.829743 0.775164 0.600818 1.059952 0.836635 1.263836 1.263472 1.185454 1.433585 1.163627 0.962585 1.149968 1.469334 1.855925 1.679439 0.594749 1.445709 1.719214 0.789600 1.195907 0.667541 1.295001 0.667277 0.323718 0.495627 1.597085 0.421887 0.690581 1.385506 1.089925 0.131009 1.255996 0.032864 1.468558 1.225026 0.657461 0.948911 0.222166 0.275901 0.020659 1.211688 0.246322 1.523156 1.507688 1.015242 1.230394 1.459286 1.744000 1.292544 0.213395 0.843999 1.828079 0.633937 1.186360 0.479150 0.586845 0.539415 0.156129 0.809864 1.874024 1.365487 0.491203 1.856921 1.833660 0.929783 1.252326 1.364500 1.636573 0.072711 1.137952 0.517906 0.985831 1.443977 1.204677 1.411602 1.856586 1.382537 0.900920 0.566665 1.785049 0.682930 0.476032 0.210775 1.346294 1.494604 0.684949 0.574219)
+      13.564762 #(0.000000 0.071021 -0.045900 0.058670 0.493841 1.293362 -0.057216 -0.000184 1.275618 0.564338 1.354066 0.854546 0.630510 -0.371770 1.618831 0.568509 0.955123 -0.307661 1.844277 0.083402 0.807294 1.962075 1.167593 1.178026 0.230928 1.432189 1.089860 -0.093605 1.119160 1.116060 0.979399 0.059008 1.943414 -0.113789 0.223874 -0.208043 0.526828 1.510935 1.797964 -0.107790 -0.093406 0.921738 1.107832 1.170045 1.836273 0.100660 1.370967 0.958982 1.684253 -0.331010 0.030278 0.977936 0.105170 0.380489 0.223544 0.950305 0.210637 0.314986 0.525205 1.607557 1.090433 0.303211 -0.105585 1.487149 0.679831 1.842396 1.531518 0.624076 1.889867 0.857038 -0.167490 0.339050 0.168133 1.455474 -0.081302 1.356595 1.715910 0.906719 0.105111 0.209521 0.345799 0.218079 0.456696 0.001743 1.898422 -0.007008 0.398362 0.772521 -0.022953 1.211429 0.017691 -0.115520 0.703102 1.583656 0.920854 0.570227 0.919384 0.963341 1.421230 1.552676 1.351871 1.770080 1.754828 1.593649 0.476733 0.910953 0.481129 0.031047 1.465883 -0.487152 1.560697 0.707650 1.745896 0.231751 1.283020 1.271734 0.711434 1.250087 1.640196)
       )
 
 ;;; 120 even --------------------------------------------------------------------------------
diff -ur snd-10/rt-DotEmacs snd-10-new/rt-DotEmacs
--- snd-10/rt-DotEmacs	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/rt-DotEmacs	2010-11-18 01:11:33.060883800 +0100
@@ -307,6 +307,22 @@
        nil t))))
 (font-lock-add-keywords
  'scheme-mode
+ '(("(\\(where\\)\\>\\s-*(?\\(\\sw+\\)?"
+    (1 font-lock-keyword-face
+       nil t))))
+(font-lock-add-keywords
+ 'scheme-mode
+ '(("(\\(compose\\)\\>\\s-*(?\\(\\sw+\\)?"
+    (1 font-lock-keyword-face
+       nil t))))
+(font-lock-add-keywords
+ 'scheme-mode
+ '(("(\\(send\\)\\>\\s-*(?\\(\\sw+\\)?"
+    (1 font-lock-keyword-face
+       nil t))))
+
+(font-lock-add-keywords
+ 'scheme-mode
  '(("(\\(new\\)\\>\\s-*(?\\(\\sw+\\)?"
     (1 font-lock-keyword-face
        nil t))))
diff -ur snd-10/rt-compiler.scm snd-10-new/rt-compiler.scm
--- snd-10/rt-compiler.scm	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/rt-compiler.scm	2010-11-18 01:11:33.097008746 +0100
@@ -39,7 +39,7 @@
 
 
 
-(define *tar-atomic-heap-size* (* 4 1024 1024))
+(define *tar-atomic-heap-size* (* 128 1024 1024))
 (define *tar-nonatomic-heap-size* (* 1 256 1024))
 (define *tar-max-mem-size* (* 512 1024))
 ;;(define *tar-roots-size* (* 1024 1024))
@@ -3548,7 +3548,7 @@
 
   (rt-ec-private-function <void-*> rt_alloc_zero (lambda (,rt-globalvardecl (<int> size))
 						   (let* ((ret <void-*> (rt_alloc_atomic rt_globals size)))
-						     (memset ret 0 size)
+						     ;;(memset ret 0 size)
 						     (return ret))))
   
   )
@@ -4979,7 +4979,7 @@
    #:feedforward
    #:size
    #:initial-contents
-   (#:initial-element 0.0)
+   ;;(#:initial-element 0.0)
    #:max-size
    (#:type mus-interp-linear))
  (make-asymmetric-fm
@@ -4991,14 +4991,14 @@
    #:scaler
    #:size
    #:initial-contents
-   (#:initial-element 0.0)
+   ;;(#:initial-element 0.0)
    #:max-size
    (#:type mus-interp-linear))
  (make-convolve #:input #:filter #:fft-size)
  (make-delay
    #:size
    #:initial-contents
-   (#:initial-element 0.0)
+   ;;(#:initial-element 0.0)
    (#:max-size)
    (#:type mus-interp-linear))
  (make-env
@@ -5644,14 +5644,6 @@
       (* hz (/ (* pi 2) (-> *rt-engine* samplerate)))
       `(* ,hz ,(/ (* pi 2) (-> *rt-engine* samplerate)))))
 
-;; mus-srate
-;(<rt-func> 'mus-srate '<float> '() #:is-immediate #t)
-;(define-c-macro (mus-srate)
-;  "rt_globals->samplerate")
-
-(define-rt-macro (mus-srate)
-  (-> *rt-engine* samplerate))
-
 
 ;; move-locsig
 (rt-renamefunc move-locsig mus_move_locsig <void> (<mus_locsig-*> <float> <float>))
@@ -7107,7 +7099,15 @@
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 (c-load-from-path rt-stalin)
+(c-load-from-path rt-generators)
+
+;; mus-srate
+;(<rt-func> 'mus-srate '<float> '() #:is-immediate #t)
+;(define-c-macro (mus-srate)
+;  "rt_globals->samplerate")
 
+(define-rt/stalin-macro (mus-srate)
+  (-> *rt-engine* samplerate))
 
 
 
@@ -7626,7 +7626,6 @@
                                               (floats <float-*> (cast <float-*> (+ ret 1))))
                                          (set! ret->length length)
                                          (set! ret->data floats)
-                                         (memset floats 0 (* (sizeof <float>) length))
                                          (return ret))))
 
 
diff -ur snd-10/rt-coroutines.scm snd-10-new/rt-coroutines.scm
--- snd-10/rt-coroutines.scm	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/rt-coroutines.scm	2010-11-18 01:11:33.103007490 +0100
@@ -162,7 +162,8 @@
            (<coroutine> coroutine)
            (<int> time)
            (<int> priority))
-    
+
+    ;;(fprintf stderr (string "insert block-coroutine: %p\\n") coroutine)
   (<struct-rt_coroutine-**> queue rt_globals->block_queue)
 
   (if (>= rt_globals->block_queue_size
diff -ur snd-10/rt-engine.scm snd-10-new/rt-engine.scm
--- snd-10/rt-engine.scm	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/rt-engine.scm	2010-11-18 01:13:11.362007489 +0100
@@ -193,6 +193,7 @@
 (eval-c ""
 	(proto->public "void tar_bench_print(tar_heap_t *heap)")
 	(proto->public "void tar_touch_heaps(tar_heap_t *heap)")
+        (proto->public "void tar_end_fragmentation_analysis(tar_heap_t *heap)")
 	)
 
 
diff -ur snd-10/rt-player.scm snd-10-new/rt-player.scm
--- snd-10/rt-player.scm	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/rt-player.scm	2010-11-18 01:11:33.109009026 +0100
@@ -459,11 +459,15 @@
   (for-each (lambda (player)
 	      (-> player cleanup-func))
 	    rt-snd-players)
-  (set! rt-snd-players '()))
+  (set! rt-snd-players '())
+  ;;(in 1000 gc)
+  )
 (define (rt-snd-stop player)
   (-> player cleanup-func)
   (set! rt-snd-players (remove (lambda (p) (eq? p player))
-			      rt-snd-players)))
+			      rt-snd-players))
+  ;;(in 1000 gc)
+  )
 
 (define (rt-snd-get-player)
   (if (null? rt-snd-players)
diff -ur snd-10/rt-stalin.scm snd-10-new/rt-stalin.scm
--- snd-10/rt-stalin.scm	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/rt-stalin.scm	2010-11-18 01:13:03.378883800 +0100
@@ -1,4 +1,6 @@
 
+;; Ide for  fikse problemet med at frste iterasjon tar mye
+;; lenger tid  eksekvere: pre-kalkulkler frste iterasjon.
 
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 ;;;;;;;;;;;;;;;;; globals ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
@@ -7,7 +9,8 @@
 (define *stalin-stack-size* (* 8 128 1024)) ;; total stack size (for safety)
 (define *stalin-stack-limit* (* 8 96 1024))  ;; If using more than this, instrument is stopped. (checked every block)
 (define *stalin-queue-max-size* 1024) ;; max number of non-sound coroutines.
-(define *stalin-add-health-checks* #t)
+(define *stalin-max-bus-channels* 64)
+(define *stalin-add-health-checks* #t) ;; If #f, overrides the :runtime-checks option
 (define *stalin-backtrace-length* 20)
 
 (define *rt-local-stalin-code-environment* (the-environment))
@@ -37,6 +40,9 @@
       (system (<-> "rm " logfilename))
       (cont output ret))))
 
+#!
+(get-system-output "echo 'hello'" c-display)
+!#
 
 (define (get-all-unique-symbols l)
   (delete-duplicates (flatten l) eq?))
@@ -55,10 +61,13 @@
         (push! (list name body) stalin-funcs))))
 
 (define (is-stalin-defined? name)
-  (memq name stalin-funcs))
+  (assq name stalin-funcs))
 
 (define (get-stalin-func name)
-  (cadr (assq name stalin-funcs)))
+  (let ((temp (assq name stalin-funcs)))
+    (if temp
+	(cadr temp)
+	#f)))
   
 (define-macro (define-stalin name . body)
   (when (pair? name)
@@ -67,26 +76,41 @@
   
   (add-stalin-func name `(define ,name ,@body))
   #t)
-  
+
+(define-macro (Define-stalin signature . body)
+  (let ((kont (rt-gensym "kont")))
+    `(define-stalin ,(append signature kont)
+       (,kont ,@body))))
+
+;; Returns global bindings referenced to by expr-top
+;;   (expr-top must be a toplevel binding)
 (define (find-stalin-funcs expr-top)
   (define ret '())
-  (let loop ((expr expr-top))
+  (let loop ((expr expr-top)
+	     (varlist '()))
+    (define (add-ret sym)
+      ;;(c-display "sym/varlist" sym (schemecodeparser-get-varlist))
+      (if (and (not (memq sym ret))
+	       (not (memq sym (schemecodeparser-get-varlist)))
+	       (assq sym stalin-funcs))
+	  (push! sym ret)))
     (schemecodeparser expr
-                      :symbolfunc (lambda (sym)
-                                    (if (assq sym stalin-funcs)
-                                        (push! sym ret)))
+		      :varlist varlist
+                      :symbolfunc add-ret
                       :elsefunc (lambda (expr)
-                                  (when (not (memq (car expr) ret))
-                                    (let ((hit (assq (car expr) stalin-funcs)))
-                                      (if hit
-                                          (push! (car hit) ret))))
-                                  (for-each loop (cdr expr)))))
+				  (add-ret (car expr))
+				  (for-each (lambda (expr)
+					      (loop expr (schemecodeparser-get-varlist)))
+					    (cdr expr)))))
   (delete-duplicates ret eq?))
-
+  
 ;;(define (add-stalin-bindings name bindings . rest)
 ;;  #t)
 
 #!
+(find-stalin-funcs '(write-bus _main-bus (read-bus 0 bus)))
+(find-stalin-funcs (stalin-super-expanded (get-stalin-func 'make-bus)))
+(pretty-print (stalin-super-expanded (get-stalin-func 'make-bus)))
 (find-stalin-funcs '(vct a b))
 (pretty-print (generate-stalin-code '((vct a b))))
 (define-stalin *var* 0)
@@ -134,6 +158,8 @@
 (define stalin-dont-rename-these '())
 
 (define (define-stalin-ec-do ret-type name body)
+  (if (defined? 'clear-stalin-cache!) ;; clear-stalin-cache! is defined later
+      (clear-stalin-cache!))
   (when (eq? 'lambda (car body))
     (let ()
       (define def (map (lambda (arg)
@@ -239,6 +265,35 @@
 (define stalin-macros (make-hash-table 219))
 
 (define (define-stalin-macro-do def body)
+  (define keys (let loop ((def def)
+			  (keys-found #f))
+		 (cond ((null? def)
+			'())
+		       ((not (pair? def))
+			'())
+		       ((keyword? (car def))
+			(loop (cdr def)
+			      #t))
+		       ((not keys-found)
+			(loop (cdr def)
+			      #f))
+		       ((pair? (car def))
+			(cons (caar def)
+			      (loop (cdr def)
+				    #t)))
+		       (else
+			(cons (car def)
+			      (loop (cdr def)
+				    #t))))))
+  (when (memq 'where keys)
+    (c-display "Error in define-stalin-macro. :where is a reserved keyword")
+    (throw 'compilation-error))
+  (when (memq 'when keys)
+    (c-display "Error in define-stalin-macro. :when is a reserved keyword")
+    (throw 'compilation-error))
+  (when (memq 'by keys)
+    (c-display "Error in define-stalin-macro. :by is a reserved keyword")
+    (throw 'compilation-error))
   (if (pair? def)
       (hashq-set! stalin-macros (car def) (primitive-eval `(labamba-onymous ,(symbol->string (car def))
                                                                             ,(cdr def)
@@ -285,6 +340,7 @@
                    (lambda ()
                      (apply qua (cdr expr)))
                    (lambda x
+		     (c-display "expr" expr)
                      (c-display (<-> "\"" (symbol->string (car expr)) "\":"))
                      (pretty-print (procedure-source qua))
                      (c-display (<-> "Error while expanding macro \"" (symbol->string (car expr))
@@ -295,67 +351,91 @@
                      ;;(error "uffda")
                      ))))))
 
+(define stalin-reserved-keywords '(:where :when :by))
 
-(define* (stalin-macroexpand expr :key (include-make-coroutine #f))
-  (schemecodeparser expr
-		    :elsefunc (lambda (expr)
-                                ;;(when (and (eq? 'set! (car expr))
-                                ;;           (not (pair? (cadr expr)))
-                                ;;           (is-stalin-defined? (cadr expr)))
-                                ;;  (c-display "Bindings defined using define-stalin can not be set!:"
-                                ;;             expr)
-                                ;;  (throw 'compilation-error))
-                                (cond ((and (eq? 'set! (car expr))
-                                            (pair? (cadr expr)))
-                                       (stalin-macroexpand
-                                        `( ,(<_> 'setter!- (car (cadr expr))) ,@(cdr (cadr expr)) 
-                                           ,(caddr expr))))
-                                      ((and (not include-make-coroutine)
-                                            (eq? 'make-coroutine (car expr))) ;; make-coroutine is redefined after macroexpand.
-                                       `(make-coroutine ,@(map (lambda (entry)
-                                                                 (if (keyword? entry)
-                                                                     `(keyword ,(keyword->symbol entry))
-                                                                     (stalin-macroexpand entry)))
-                                                               (cdr expr))))
-                                      (else
-                                       (let ((topexpand (stalin-macroexpand-1 expr)))
-                                         ;;(c-display "expr/topexpand" expr topexpand)
-                                         (if (eq? expr topexpand)
-                                             `(,(car expr) ,@(map stalin-macroexpand (cdr expr)))
-                                             (stalin-macroexpand topexpand))))))))
-
-(define (stalin-macroexpand-make-coroutine code)
-  (c-display "stalin-macroexpand-make-coroutine entry")
-  (if #f
-      (stalin-macroexpand code :include-make-coroutine #t)
-      (schemecodeparser code
-                        :symbolhandler
-                        (list 'make-coroutine
-                              (lambda (expr)
-                                (stalin-macroexpand (stalin-macroexpand-1
-                                                     `(make-coroutine ,@(map (lambda (entry)
-                                                                               (if (and (pair? entry)
-                                                                                        (eq? 'keyword (car entry)))
-                                                                                   (symbol->keyword (cadr entry))
-                                                                                   entry))
-                                                                             (cdr expr))))))))))
-
-#!
-(stalin-macroexpand '(quasiquote ((unqoute a) 0)))
-(stalin-macroexpand '(quasiquote (((unquote a) 1))))
-
-(define-stalin-macro (dosomething b :key (c 100))
-  `(+ 1 ,b 2 ,c))
-(stalin-macroexpand-1 '(dosomething 3 (symbol->keyword 'c) 2))
-(pretty-print (stalin-macroexpand '(let-keywords* lambda*:G787 #f ((c 100)) (unquote c))))
+(define* (stalin-macroexpand expr)
+  (let expand ((expr expr))
+    (schemecodeparser expr
 
-(pretty-print (fix-stalin-keywords (stalin-macroexpand '(lambda* (:key (c "ai")) c))))
-(fix-stalin-keywords (stalin-macroexpand '(debug (a :c "hello"))))
+		      :use-customsymbolhandler?
+		      (lambda (expr)
+			(any (lambda (reserved) (memv reserved expr)) stalin-reserved-keywords))
+
+		      :customsymbolhandler
+		      (lambda (expr)
+			(define rev-expr (reverse expr))
+			(cond ((eq? 'lambda (car expr))
+			       (expand `(lambda ,(cadr expr)
+					  (begin
+					    ,@(cddr expr)))))
+			      ((eq? 'define (car expr))
+			       (expand `(define ,(cadr expr)
+					  (begin
+					    ,@(cddr expr)))))
+			      (else
+			       (let ((key (let loop ((expr rev-expr))
+					    (cond ((eqv? :where (car expr)) :where)
+						  ((eqv? :when (car expr)) :when)
+						  ((eqv? :by (car expr)) :by)
+						  (else
+						   (loop (cdr expr)))))))
+				 
+				 (call-with-values (lambda () (break (lambda (t) (eqv? key t))
+								     rev-expr))
+				   (lambda (before_ after_)
+				     (define before (reverse after_))
+				     (define after (reverse before_))
+				     ;;(c-display "rev" rev-expr)
+				     ;;(c-display "before" before)
+				     ;;(c-display "after" after "\n")
+				     (cond ((eqv? key :where)
+					    (expand `(let ((,(car after) ,(cadr after)))
+						       (,@(butlast before 1)
+							,@(cddr after)))))
+					   ((eqv? key :when)
+					    (expand `(if ,(car after)
+							 (,@(butlast before 1)
+							  ,@(cdr after)))))
+					   (else ;; :by
+					    (expand `(,(car after)
+						      (,@(butlast before 1)
+						       ,@(cdr after))))))))))))
+		      
+		      
+		      :elsefunc (lambda (expr)
+				  ;;(when (and (eq? 'set! (car expr))
+				  ;;           (not (pair? (cadr expr)))
+				  ;;           (is-stalin-defined? (cadr expr)))
+				  ;;  (c-display "Bindings defined using define-stalin can not be set!:"
+				  ;;             expr)
+				  ;;  (throw 'compilation-error))
+				  (cond ((eq? 'set! (car expr))
+					 (let ((name (cadr expr))
+					       (val (caddr expr)))
+					   (cond ((pair? name)
+						  (stalin-macroexpand
+						   `( ,(<_> 'setter!- (car name)) ,@(cdr (cadr expr)) 
+						      ,val)))
+						 (else
+						  `(set! ,name ,(stalin-macroexpand val))))))
+
+					(else
+					 (let ((topexpand (stalin-macroexpand-1 expr)))
+					   (if (eq? expr topexpand)
+					       `(,(car expr) ,@(map stalin-macroexpand (cdr expr)))
+					       (stalin-macroexpand topexpand)))))))))
+  
+#!
+(stalin-macroexpand '(+ a b
+			:where c 9
+			:where d 10))
 
+(stalin-macroexpand '(stop :when a :when #f))
 !#
 
 
 
+
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 ;;;;;;;;;;;;; optargs ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
@@ -476,6 +556,17 @@
   l)
 
 
+(define-stalin-ec <void> dont_gc_this_block (lambda ()
+                                              (tar_dont_gc_now heap)))
+
+(define-stalin-ec <void*> get_NULL_ (lambda ()
+				      (return NULL)))
+(define-stalin NULL_ (get_NULL_))
+
+(define-stalin-ec <int> is_NULL_ (lambda ((<void*> arg))
+				   (return arg==NULL)))
+(define-stalin (is_NULL arg)
+  (= 1 (is_NULL_ arg)))
 
 (define-stalin-ec <void> lowlevel_remove_me (lambda ()
                                               (myexit)))
@@ -537,8 +628,44 @@
   (lambda ((<unsigned-long> address))
     (return (cast <void*> address))))
 
+#!
+(compose (+ 2) (+ 3))
+->
+(lambda (a) (+ 2 (+ 3 a)))
+!#
+
+(define-stalin-macro (compose . args)
+  (define lambda-arg (rt-gensym))
+  `(lambda (,lambda-arg)
+     ,(let loop ((args args))
+	(cond ((null? args)
+	       lambda-arg)
+	      ((pair? (car args))
+	       `(,@(car args) ,(loop (cdr args))))
+	      (else
+	       `(,(car args) ,(loop (cdr args))))))))
 
 
+#!
+(pretty-print (stalin-macroexpand '(compose (+ 2) (+ 3))))
+(pretty-print (stalin-macroexpand '(compose + -)))
+!#
+
+(define-stalin-macro (send a :rest through :allow-other-keys)
+  (let loop ((args (cdr through)))
+    (cond ((null? args)
+	   a)
+	  ((pair? (car args))
+	   `(,@(car args) ,(loop (cdr args))))
+	  (else
+	   `(,(car args) ,(loop (cdr args)))))))
+
+#!
+(pretty-print (stalin-macroexpand '(out a :where a 5)))
+(pretty-print (stalin-macroexpand '(send 9 :through add subtract)))
+(pretty-print (stalin-macroexpand '(out a :where a (send 9 :through +))))
+!#
+
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 ;; structures (providing same structure syntax for rt-stalin as guile and snd-rt)
 
@@ -618,8 +745,8 @@
         ))))
 
 (define-macro (define-stalin-struct_internal name . das-slots)
-  (define name-name (rt-gensym))
-  (define val-name (rt-gensym))
+  (define name-name (rt-gensym2))
+  (define val-name (rt-gensym2))
   (define slots '())
   
   (for-each (lambda (slot)
@@ -662,8 +789,8 @@
        )))
 
 (define-macro (define-stalin-struct name . das-slots)
-  (define name-name (rt-gensym))
-  (define val-name (rt-gensym))
+  (define name-name (rt-gensym2))
+  (define val-name (rt-gensym2))
   (define make-name (<_> 'make- name))
   (define internal-make-name (<_> 'make- name '-internal))
   (define slots '())
@@ -783,6 +910,8 @@
         (+= data->val val))
     (set! data->last_written_to block_time)))
 
+
+;; Is this function used anywhere?
 (define-stalin-ec <void> rt_write_out_bus
   (lambda ((<int> ch)
            (<int> time)
@@ -812,6 +941,64 @@
 ;; ADSR envelope
 
 (define-stalin (make-adsr-do a d s r)
+  (define in (rt_make_env (vct 0 0 a 1 (+ a d) s) (+ a d) 1.0)) ;; Small optimization.
+  ;;(define in (make-env `((0 0)(,a 1)(,(+ a d) ,s)) :dur (+ a d)))
+  (define out (make-env '((0 1)(1 0)) :dur r))
+  (define do-out #f)
+  (define do-in #t)
+  (define vol 0.0)
+  (define time 0)
+  (lambda (command)
+    (case command
+      ((next)
+       (inc! time 1)
+       (cond (do-out
+	      (* vol (env out)))
+	     (do-in
+	      (cond ((= time (+ a d))
+		     (set! do-in #f)
+		     (set! vol s))
+		    (else
+		     (set! vol (env in))))
+	      vol)
+	     (else
+	      vol)))
+      ((is-running)
+       (or (not do-out)
+	   (< time r)))
+      ((stop)
+       (set! time 0)
+       (set! do-out #t)))))
+
+#!
+Use it like this:
+
+(<rt-stalin>
+  (sound
+    (out (+ (* 0.5 softsynth)
+            (* 0.0953 reverb)
+
+            :where reverb (+ (comb :scaler 0.742 :size  9601 allpass-sum)
+                             (comb :scaler 0.733 :size 10007 allpass-sum)
+                             (comb :scaler 0.715 :size 10799 allpass-sum)
+                             (comb :scaler 0.697 :size 11597 allpass-sum)
+                             :where allpass-sum (send softsynth :through
+                                                      (all-pass :feedback -0.7 :feedforward 0.7)
+                                                      (all-pass :feedback -0.7 :feedforward 0.7)
+                                                      (all-pass :feedback -0.7 :feedforward 0.7)
+                                                      (all-pass :feedback -0.7 :feedforward 0.7)))
+            :where softsynth (in (while #t
+                                   (wait-midi :command note-on
+                                     (sound :while (-> adsr is-running)
+                                       (out (* (-> adsr next) (midi-vol) (oscil :freq (midi-to-freq (midi-note))))))
+                                     (spawn
+                                       (wait-midi :command note-off :note (midi-note)
+                                         (-> adsr stop)))
+                                     :where adsr (make-adsr :a 20:-ms :d 30:-ms :s 0.2 :r 70:-ms))))))))
+
+
+;; old one
+(define-stalin (make-adsr-do a d s r)
   (define in (rt_make_env (vct 0 0 a 1 (+ a d) s) (+ a d))) ;; Small optimization.
   ;;(define in (make-env `((0 0)(,a 1)(,(+ a d) ,s)) :dur (+ a d)))
   (define out (make-env '((0 1)(1 0)) :dur r))
@@ -838,37 +1025,6 @@
           (else
            vol))))
 
-#!
-(define-stalin (make-adsr-do a d s r)
-  (define in (rt_make_env (vct 0 0 a 1 (+ a d) s) (+ a d))) ;; Small optimization.
-  ;;(define in (make-env `((0 0)(,a 1)(,(+ a d) ,s)) :dur (+ a d)))
-  (define out (make-env '((0 1)(1 0)) :dur r))
-  (define do-out #f)
-  (define do-in #t)
-  (define vol 0.0)
-  (define time 0)
-  (lambda (command)
-    (case command
-      ('run (lambda ()
-              (inc! time 1)
-              (cond (do-out
-                     (* vol (env out)))
-                    (do-in
-                     (cond ((= time (+ a d))
-                            (set! do-in #f)
-                            (set! vol s))
-                           (else
-                            (set! vol (env in))))
-                     vol)
-                    (else
-                     vol))))
-      ('stopped? (lambda ()
-                   (and do-out
-                        (>= time r))))
-      ('stop (lambda ()
-               (set! time 0)
-               (set! do-out #t))))))
-
 (define-stalin-struct adsr-data
   :in (make-env)
   :out (make-env)
@@ -888,7 +1044,7 @@
          (* (=> adsr-data :vol) (env (=> adsr-data :out))))
         ((=> adsr-data :do-in)
          (cond ((= (=> adsr-data :time)) (=> adsr-data :a+d)
-                (set! (=> adsr-data :do-in) #f)
+                (set! (=> sadsr-data :do-in) #f)
                 (set! (=> adsr-data :vol) s))
                (else
                 (set! (=> adsr-data :vol) (env (=> adsr-data :in)))))
@@ -956,6 +1112,7 @@
 
 (cdr (assq 'documentation (procedure-properties make-oscil)))
 (cdr (assq 'documentation (procedure-properties make-env)))
+(cdr (assq 'documentation (procedure-properties make-all-pass)))
 (procedure-properties make-env)
 
 (define *rt-temp-filename* (let ((ret (tmpnam)))
@@ -1017,6 +1174,7 @@
                                   (not (defined? name)))
                                 all-clm-constructor-names))))
 
+(get-clm-proto make-all-pass)
 
 
 
@@ -1077,34 +1235,77 @@
 ;;
 ;; This is just a quick get-up-and-running implementation. More work is needed.
 (for-each (lambda (clm-def)
-            ;;(c-display "clm-def" clm-def)
+	    (define (to-symbol s) (if (symbol? s) s (keyword->symbol s)))
             (let* ((name (car clm-def)) ;; make-oscil
-                   (gen-name (string->symbol (substring (symbol->string name) 5 (string-length (symbol->string name))))) ;; oscil
-                   (args (cdr clm-def))
-                   (argnames (map (lambda x (rt-gensym)) (iota (length args))))
-                   (fixed-args-list (map (lambda (arg)
-                                           (let ((def 0)
-                                                 (n #f))
-                                             (if (pair? arg)
-                                                 (begin
-                                                   (set! n (car arg))
-                                                   (if (not (null? (cdr arg)))
-                                                       (set! def (primitive-eval (cadr arg)))))
-                                                 (set! n arg))
-                                             (if (keyword? n)
-                                                 (set! n (keyword->symbol n)))
-                                             (list n def)))
+                   (gen-name (string->symbol (substring (symbol->string name) 5 (string-length (symbol->string name))))) ;; oscil / all-pass
+		   (gen-c-name (string->symbol (list->string (map (lambda (c) (if (char=? c #\-) #\_ c)) (string->list (symbol->string gen-name)))))) ;; oscil / all_pass
+                   (args (remove (lambda (arg) (equal? :optional arg)) (cdr clm-def)))
+		   (typedefaults (map (lambda (arg)
+					(define name #f)
+					(define default #f)
+					(cond ((and (pair? arg)
+						    (null? (cdr arg)))
+					       (set! name (to-symbol (car arg))))
+					      ((pair? arg)
+					       (set! name (to-symbol (car arg)))
+					       (set! default (cadr arg)))
+					      (else
+					       (set! name (to-symbol arg))))
+					(let ((type (cond ((memq name '(size fft-size max-size type))
+							   '<int>)
+							  ((memq name '(initial-contents))
+							   '<void*>)
+							  (else
+							   '<float>))))
+					  (set! default (or default
+							    (case type
+							      ((<int>) 0)
+							      ((<void*>) ''(get_NULL_))
+							      ((<float>) 0.0))))
+					  (list name type default)))
+				      args))
+		   (names (map car typedefaults))
+		   (types (map cadr typedefaults))
+		   (defaults (map caddr typedefaults))
+                   (argnames (map (lambda x (rt-gensym2)) (iota (length args))))
+                   (fixed-args-list (map (lambda (default arg)
+                                           (let ((argname #f))
+					     (if (eq? name 'make-comb)
+						 (c-display default arg))
+                                             (cond ((pair? arg)
+						    (begin
+						      (set! argname (car arg))
+						      (if (not (null? (cdr arg)))
+							  (set! default (primitive-eval (cadr arg))))))
+						   ((equal? :max-size arg)
+						    (set! argname arg)
+						    (set! default -1))
+						   (else
+						    (set! argname arg)))
+                                             (if (keyword? argname)
+                                                 (set! argname (keyword->symbol argname)))
+                                             (list argname default)))
+					 defaults
                                          args))
                    )
-
+	      (if (eq? name 'make-comb)
+		  (c-display "fixed args" fixed-args-list))
               (supereval
                (lambda (out)
 
-                 (out "(define-stalin-ec <void*> make_" gen-name "_ (lambda (")
-                 (for-each (lambda (arg)
-                             (out `(<float> ,arg)))
+                 (out "(define-stalin-ec <void*> make_" gen-c-name "_ (lambda (")
+                 (for-each (lambda (type arg)
+                             (out `(,type ,arg)))
+			   types
                            argnames)
-                 (out ")(return (mus_make_" gen-name " ")
+                 (out ")")
+		 ;;(c-display "names" names argnames (zip names argnames))
+		 (if (and (memq 'max-size names)
+			  (memq 'size names))
+		     (let ((maxname (cadr (assq 'max-size (zip names argnames))))
+			   (sizename (cadr (assq 'size (zip names argnames)))))
+		       (out "  (if (== -1 " maxname ") (set! " maxname " " sizename "))")))
+		 (out "(return (mus_make_" gen-c-name " ")
                  (for-each (lambda (arg)
                              (out " " arg))
                            argnames)
@@ -1115,23 +1316,28 @@
                              (out arg " "))
                            fixed-args-list)
                  (out ")\n")
-                 (out "  `(" 'make_ gen-name "_ ")
+		 (out "  `(" 'make_ gen-c-name "_ ")
                  (for-each (lambda (arg)
                              (out "," (car arg) " "))
                            fixed-args-list)
                  (out "))\n")))))
           clm-constructor-protos)
 #!
+(stalin-macroexpand '(make-comb :scaler 0.742 :size 9601))
 (pretty-print (get-stalin-macro 'make-waveshape))
 (stalin-macroexpand-1 '(make-waveshape))
 (stalin-macroexpand '(make-waveshape))
 (stalin-macroexpand '(make-oscil :frequency 400))
+(pretty-print (stalin-macroexpand '(oscil :frequency 400)))
 (stalin-macroexpand '(make-env))
 (pretty-print (get-stalin-macro 'make-waveshape))
 (pretty-print (get-stalin-ec-function 'make_waveshape_))
 (pretty-print (get-stalin-ec-function 'make_oscil_))
 (begin stalin-ec-functions)
 (get-stalin-func 'make_delay_)
+(pretty-print (stalin-macroexpand '(delay del :size (* .013 (mus-srate)))))
+(pretty-print (stalin-macroexpand '(make-delay :size 50)))
+(begin clm-constructor-protos)
 
 (define-stalin-macro (make-waveshape :optkey
                                      (frequency *clm-default-frequency*)
@@ -1146,26 +1352,42 @@
 (for-each (lambda (clm-gen)
             ;;(c-display "gen" clm-gen)
             (let* ((name (car clm-gen)) ;; oscil
+		   (c-name (string->symbol (list->string (map (lambda (c) (if (char=? c #\-) #\_ c)) (string->list (symbol->string name)))))) ;; oscil / all_pass
                    (args (cadr clm-gen))
-                   (argnames (map (lambda x (rt-gensym)) (iota (length args))))
+                   (argnames (map (lambda x (rt-gensym2)) (iota (length args))))
                    )
               ;;(c-display (<_> name '_))
-              (define-stalin-ec-do '<float> (<_> name '_)
+              (define-stalin-ec-do '<float> (<_> c-name '_)
                 `(lambda ,(cons '(<void*> generator)
                                 (map (lambda (argname)
                                        `(<float> ,argname))
                                      argnames))
-                   (return (,(<_> 'mus_ name) (cast <mus_any*> generator) ,@argnames))))
+                   (return (,(<_> 'mus_ c-name) (cast <mus_any*> generator) ,@argnames))))
               ))
           rt-clm-generators)
 
+(define (stalin-internal-split-args args)
+  (let* ((gen-args '())
+	 (con-args (let loop ((args args))
+		     (cond ((null? args)
+			    '())
+			   ((keyword? (car args))
+			    (append (list (car args)
+					  (cadr args))
+				    (loop (cddr args))))
+			   (else
+			    (set! gen-args args)
+			    '())))))
+    (list gen-args con-args)))
+
 (for-each (lambda (clm-gen)
-            (let* ((name (car clm-gen)) ;; oscil
+            (let* ((name (car clm-gen)) ;; oscil / all-pass
+		   (c-name (string->symbol (list->string (map (lambda (c) (if (char=? c #\-) #\_ c)) (string->list (symbol->string name)))))) ;; oscil / all_pass
                    (args (cadr clm-gen))                   
-                   (argnames (map (lambda x (rt-gensym)) (iota (length args)))))
+                   (argnames (map (lambda x (rt-gensym2)) (iota (length args)))))
               (supereval
                (lambda (out)
-                 (out "(define-stalin-macro (" name " generator ")
+                 (out "(define-stalin-macro (" name "_internal generator ")
                  (for-each (lambda (must-arg)
                              (out must-arg " "))
                            (remove pair? args))
@@ -1175,19 +1397,32 @@
                                (out opt-arg " "))
                              (%filter pair? args)))
                  (out ")\n")
-                 (out "`(" name "_ ,generator ")
+                 (out "`(" c-name "_ ,generator ")
                  (for-each (lambda (arg)
                              (if (pair? arg)
                                  (out " ," (car arg))
                                  (out " ," arg)))
                            args)
-                 (out "))")))))
+                 (out "))")
+		 (out "(define-stalin-macro (" name " :rest rest :allow-other-keys)")
+		 (out "  (if (or (null? rest)")
+		 (out "          (not (keyword? (car rest))))")
+		 (out "      `(" name "_internal ,@rest)")
+		 (out "      (let ((args (stalin-internal-split-args rest)))")
+		 (out "        `(" name "_internal (autovar ,(rt-gensym \"" name "\") (make-" name " ,@(cadr args)) NULL_ is_NULL) ,@(car args)))))")))))
+	  
           rt-clm-generators)
 
 #!
 (pretty-print (get-stalin-ec-function 'oscil_))
-(stalin-macroexpand '(oscil gen 3))
+(pretty-print (get-stalin-ec-function 'delay_))
+(stalin-macroexpand-1 (stalin-macroexpand-1 (stalin-macroexpand-1 '(delay gen 3))))
+(pretty-print (stalin-macroexpand '(delay :size 3 a)))
+(pretty-print (procedure-source (get-stalin-macro 'delay)))
+(pretty-print (procedure-source (get-stalin-macro 'delay_internal)))
+(pretty-print (stalin-macroexpand '(oscil :freq 440)))
 (pretty-print (get-stalin-ec-function 'make_oscil_))
+(pretty-print (stalin-macroexpand '(all-pass :feedback -0.7 :feedforward 0.7 something somethingelse)))
 !#
 
 ;; Add the freq argument.
@@ -1206,14 +1441,15 @@
 (define-stalin-ec <float> mus_random_ (lambda ((<float> high))
                                         (return (mus_random high))))
 (define-stalin (random a)
-  (mus_random_ a))
+  (abs (mus_random_ a)))
 
 (define-stalin (ibetween a b)
   (+ a (irandom (- b a))))
 (define-stalin (between a b)
   (+ a (random (- b a))))
 
-
+(define-stalin-ec <void> seed (lambda ((<int> val))
+                                (mus_set_rand_seed val)))
 
 ;;;;; vct (quick up-and-running. More work needed)
 
@@ -1225,7 +1461,6 @@
            (floats <float-*> (cast <float-*> (+ ret 1))))
       (set! ret->length length)
       (set! ret->data floats)
-      (memset floats 0 (* (sizeof <float>) length))
       (return ret))))
 
 (define-stalin (make-vct len)
@@ -1272,11 +1507,13 @@
 ;;;;; env (quick up-and-running. More work needed)
 
 (define-stalin-ec <void*> rt_make_env (lambda ((<void*> vvct)
-                                               (<int> duration))
+                                               (<int> duration)
+                                               (<double> scaler))
                                         (<vct*> das_vct (cast <vct-*> vvct))
                                         (<void*> ret (mus_make_env das_vct->data
                                                                    (/ das_vct->length 2)
-                                                                   1.0 0 1.0 0
+                                                                   scaler
+                                                                   0 1.0 0
                                                                    duration ;; end
                                                                    NULL))
                                         (when (== NULL ret)
@@ -1284,32 +1521,32 @@
                                         (return ret)))
                                           
 
-(define-stalin (make-env-do data dur)
+(define-stalin (make-env-do data dur scaler)
   (define vct (make-vct (length data)))
   (define i -1)
   (for-each (lambda (val)
               (vct-set! vct (inc! i 1) val))
             data)
-  (rt_make_env vct dur))
+  (rt_make_env vct dur scaler))
 
-(define-stalin (make-env-do-pairs data dur)
+(define-stalin (make-env-do-pairs data dur scaler)
   (define vct (make-vct (* 2 (length data))))
   (define i -1)
   (for-each (lambda (val)
               (vct-set! vct (inc! i 1) (car val))
               (vct-set! vct (inc! i 1) (cadr val)))
             data)
-  (rt_make_env vct dur))
+  (rt_make_env vct dur scaler))
 
-(define-stalin (make-env-parse-data-at-runtime data dur)
+(define-stalin (make-env-parse-data-at-runtime data dur scaler)
   (if (pair? (car data))
-      (make-env-do-pairs data dur)
-      (make-env-do  data dur)))
+      (make-env-do-pairs data dur scaler)
+      (make-env-do  data dur scaler)))
 
-(define-stalin-macro (make-env-constant-data data dur)
-  `(rt_make_env (vct ,@(flatten data)) ,dur))
+(define-stalin-macro (make-env-constant-data data dur scaler)
+  `(rt_make_env (vct ,@(flatten data)) ,dur ,scaler))
 
-(define-stalin-macro (make-env data :optkey duration dur end)
+(define-stalin-macro (make-env data :optkey duration dur end (scaler 1.0))
   (define das-dur (or (and duration `(infix-s ,duration))
                       dur
                       end
@@ -1317,11 +1554,11 @@
   (let ()
     (define das-data (stalin-macroexpand data))
     (cond ((not (pair? das-data))
-           `(make-env-parse-data-at-runtime ,das-data ,das-dur))
+           `(make-env-parse-data-at-runtime ,das-data ,das-dur ,scaler))
           ((eq? 'quote (car das-data))
-           `(make-env-constant-data ,(cdr das-data) ,das-dur))
+           `(make-env-constant-data ,(cdr das-data) ,das-dur ,scaler))
           (else
-           `(make-env-parse-data-at-runtime ,das-data ,das-dur)))))
+           `(make-env-parse-data-at-runtime ,das-data ,das-dur ,scaler)))))
 
 #!
 (stalin-macroexpand '(make-env `((0 0)(,a 1)(,(+ a d) ,s)) :dur (+ a d)))
@@ -1354,7 +1591,6 @@
 
 
 
-
 ;;;;; Alsa midi
 
 ;; midi-to-freq made by looking at the pd source
@@ -1364,7 +1600,11 @@
         (else
          (* 8.17579891564 (exp (* .0577622650 freq))))))
 
-(define-stalin midi-to-hz midi-to-freq)
+(define-stalin midi->hz midi-to-freq)
+
+(define-stalin (midi->radians midi)
+  (hz->radians (midi->hz midi)))
+
 
 (add-stalin-ec 'midi_eventnum '(<int> midi_eventnum 0))
 (add-stalin-ec 'midi_control '(<int> midi_control[500] {0}))
@@ -1447,7 +1687,7 @@
 
 ;; wait-midi/wait-midi-do is a bit messy. I had big problems
 ;; making it produce code which stalin was able to tail-optimize
-;; without using -fully-convert-to-CPS
+;; without using the -fully-convert-to-CPS option.
 (define-stalin (wait-midi-do check body)
 
   (when (not (= _time _last-midi-receive-time))
@@ -1479,32 +1719,46 @@
        
 
 (define-stalin-macro (wait-midi :key 
-                                 (command #t)
+                                 command
                                  note
                                  :rest rest)
-  (define control (rt-gensym "control"))
-  (define data1 (rt-gensym "data1"))
-  (define data2 (rt-gensym "data2"))
-  (define return (rt-gensym "return-from-midi"))
-  (define code rest)
-  `(call/cc
-    (lambda (,return)
-      (let loop ()
-        (if (wait-midi-do (lambda (,control ,data1 ,data2)
-                            ,(cond ((eq? command 'note-on)
-                                    `(_midi-play? ,control ,data2))
-                                   ((eq? command 'note-off)
-                                    `(and (_midi-stop? ,control ,data2)
-                                          (= ,data1 ,note)))))
-                          (lambda (_curr-midi-control
-                                   _curr-midi-data1
-                                   _curr-midi-data2)
-                            ,@code))
-            (,return #t)
-            (wait-synch 1:-b
-               (loop)))))))
+  (fix-defines
+   (define control (rt-gensym "control"))
+   (define data1 (rt-gensym "data1"))
+   (define data2 (rt-gensym "data2"))
+   (define return (rt-gensym "return-from-midi"))
+   (define loop (rt-gensym "wait-midi-loop"))
+   (define code rest)
+   (define (get-clauses)
+     (define ret '())
+     (c-display "note:" note)
+     (if (eq? command 'note-on)
+	 (push! `(_midi-play? ,control ,data2) ret))
+     (if (eq? command 'note-off)
+	 (push! `(_midi-stop? ,control ,data2) ret))
+     (if note
+	 (push! `(= ,data1 ,note) ret))
+     (reverse ret))
+   `(call/cc
+     (lambda (,return)
+       (let ,loop ()
+	    (if (wait-midi-do (lambda (,control ,data1 ,data2)
+				(and ,@(get-clauses)))
+			      (lambda (_curr-midi-control
+				       _curr-midi-data1
+				       _curr-midi-data2)
+				,@code))
+		(,return #t)
+		(wait-synch 1:-b
+			    (,loop))))))))
 
+#!
+(pretty-print (stalin-macroexpand '(wait-midi :command note-on :note note-num
+				     (set! volume (midi-vol)))))
 
+(pretty-print (stalin-macroexpand '(wait-midi :command note-off :note note-num
+				     (set! volume 0.0))))
+!#
 
 (define-stalin-macro (_midi-play? :optkey
                                  (control '_curr-midi-control)
@@ -1544,6 +1798,17 @@
 
 
 
+;;;;; Various
+
+(define-stalin pi ,pi)
+(define-stalin pi/2 ,(/ pi 2))
+(define-stalin pi/4 ,(/ pi 4))
+
+(define-stalin (mus-srate)
+  ,(-> *rt-engine* samplerate))
+
+
+
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 ;; coroutines
 
@@ -1552,50 +1817,27 @@
   )
 
 (define coroutine-slots 
-  (let ((ret '(
-  :time 0
-  :stop-me #f
-  :continuation neverending-scheduling
-  :soundholder (=> coroutine:_current-coroutine :soundholder)
-  :parent _sound-coroutine ;; Only used when traversing the sound graph. Allways points to a sound coroutine.
-  :soundfunc (lambda ()) ;; Not a continuation.
-  :bus (=> coroutine:_current-coroutine :bus)
-  :is-sound #f
-  )))
+  (let ()
+    (define ret '(:time 0
+	          :stop-me #f
+		  :continuation neverending-scheduling
+		  :soundholder (=> coroutine:_current-coroutine :soundholder)
+		  :parent _sound-coroutine ;; Only used when traversing the sound graph. Allways points to a sound coroutine.
+		  :soundfunc (lambda ()) ;; Not a continuation.
+		  :bus (=> coroutine:_current-coroutine :bus)
+		  :is-sound #f
+		  ))
     (primitive-eval `(define-stalin-struct coroutine ,@ret))
     ret))
 
-(define extra-coroutine-slots '())
 
-(define (reset-coroutine-struct!)
-  (c-display "reset-coroutine-struct!")
-  (set! extra-coroutine-slots '())
-  (primitive-eval `(define-stalin-struct coroutine ,@coroutine-slots)))
-
-(define (redefine-coroutine-struct!)
-  (c-display "coroutine struct redefined" extra-coroutine-slots)
-  (primitive-eval `(define-stalin-struct coroutine ,@coroutine-slots ,@extra-coroutine-slots))
-  #t)
-
-(define (add-coroutine-slot name default)
-  (c-display "add-coroutine-slot" name default)
-  (push! default extra-coroutine-slots)
-  (push! name extra-coroutine-slots))
-
-#!
-(define-stalin-macro (hepp)
-  (add-coroutine-slot :testing 50)
-  `(sound (out (random 0.5))))
-(<rt-stalin>
- (hepp))
-!#
 
                                
 ;; Make sure gcc does tail call optimization.
 (define-stalin (neverending-scheduling)
   (_run-scheduler neverending-scheduling))
 
-(define-stalin _coroutine-dummy (make-coroutine :soundholder _main-soundholder :bus _main-bus :parent #f))
+(define-stalin _coroutine-dummy #f) ;; Set during initialization
 
 (define-stalin _current-coroutine
   (make-coroutine :continuation
@@ -1626,7 +1868,8 @@
 (define-stalin _next-scheduled-time 0)
 
 (define-stalin _queue-size 0)
-(define-stalin _queue (make-vector ,*stalin-queue-max-size* _coroutine-dummy))
+(define-stalin _queue #f) ;; Set during initialization 
+
 
 
 (define-stalin (get-first-coroutine-in-queue)
@@ -1656,13 +1899,15 @@
         (set! got-it #t)))
 
   (vset! i _queue last)
-
+  
   (set! _next-scheduled-time (>> (=> :coroutine(vref 1 _queue) :time) 2))
 
   (set! (=> coroutine:ret :time)
         (>> (=> coroutine:ret :time)
             2))
 
+  (vset! (1+ size) _queue _coroutine-dummy) ;; So that it can be garbage collected.
+
   ret)
 
 
@@ -1672,7 +1917,6 @@
 ;;
 ;; Returns false in case the priority queue is full.
 (define-stalin (insert-coroutine-in-queue! coroutine time priority)
-
   (define queue _queue)
 
   (if (>= _queue-size
@@ -1833,9 +2077,7 @@
 (define-stalin (_sound-runner soundholder)
   (define coroutine _current-coroutine)
   (define time _time)
-
   (_remove-stopped-sounds! soundholder)
-  
   (for-each (lambda (coroutine)
               (when (not (=> coroutine :stop-me))
                 (set! _current-coroutine coroutine)
@@ -1843,7 +2085,6 @@
                 ((=> coroutine :soundfunc))
                 (set! (=> coroutine :time) _time)))
             (=> soundholder :sub-sounds))
-
   (set! _current-coroutine coroutine)
   (set! _time time))
 
@@ -1859,7 +2100,7 @@
 
 ;; The root sound coroutine.
 ;; The only coroutine running with priority 3.
-;; That that it can not contain data from _current-coroutine because of circular dependency.
+;; Note that it can not contain data from _current-coroutine because of circular dependency.
 (define-stalin _sound-coroutine
   (make-coroutine :continuation _main-sound-runner
                   :soundholder _main-soundholder
@@ -1917,18 +2158,33 @@
 (define-stalin-macro (sound :key
                             dur
                             duration
+			    (while #t)
                             :rest code)
-  (define sound (rt-gensym "sound"))  
+  (define sound (if (eq? while #t)
+		    `(sound-internal_
+		      ,@code)
+		    (let ((soundname (rt-gensym "sound"))
+			  (loop (rt-gensym "loop")))
+		      `(let ((,soundname (sound-internal_
+					  ,@code)))
+			 (spawn
+			   (let ,loop ()
+			     (cond (,while
+				       (wait-synch 1:-b)
+				     (,loop))
+				   (else
+				    (stop ,soundname)))))
+			 ,soundname))))
+		      
   (if (or duration dur)
-      `(let ((,sound (sound-internal_
-                      ,@code)))
-         (spawn
-           (wait (inexact->exact (floor ,(or dur duration))))
-           (stop ,sound))
-         ,sound
-         )
-      `(sound-internal_
-        ,@code)))
+      (let ((soundname (rt-gensym "sound")))
+	`(let ((,soundname ,sound))
+	   (spawn
+	     (wait (inexact->exact (floor ,(or dur duration))))
+	     ;;(debug "stopping it")
+	     (stop ,soundname))
+	   ,soundname))
+      sound))
 
 
 (define-stalin-macro (block :key
@@ -2050,93 +2306,178 @@
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 ;; buses
+;;
+;; ch0 and ch1 are always available. Other channels are allocated if needed.
 
-(define-stalin _all-buses '())
 
-(define-stalin-ec <void> clear_bus_
-  (lambda ((<void*> bus))
-    (memset bus 0 (* (sizeof <float>) ,*rt-block-size*))))
+(define-stalin _all-buses '())
 
-(define-stalin clear-bus clear_bus_)
+;; Not needed. Just allocate a new one instead.
+;;(define-stalin-ec <void> clear_busch_
+;;  (lambda ((<void*> busch))
+;;    (memset busch 0 (* (sizeof <float>) ,*rt-block-size*))))
+
+(define-stalin-macro (for-each-busch_ das-bus busch ch . code)
+  (define loop (rt-gensym "for-each-busch"))
+  (define ch (rt-gensym "ch"))
+  (define bus (rt-gensym "bus"))
+  `(let ((,bus ,das-bus))
+     (let ,loop ((,ch 0))
+	  (let ((,busch (vector-ref bus ch)))
+	    (when (not (is_NULL ,busch))
+	      ,@code
+	      (,loop (1+ ,ch)))))))
+
+;; Not used. Here for debugging
+(define-stalin-ec <void> clear_busch_
+  (lambda ((<void*> busch))
+    (memset busch 0 (* (sizeof <float>) ,*rt-block-size*))))
+
+(define-stalin (clear-bus bus)
+  (vector-fill! bus NULL_)
+  ;;(clear_busch_ (vector-ref bus 0))
+  (vector-set! bus 0 (make_busch_))
+  (vector-set! bus 1 (make_busch_)))
 
-(define-stalin-ec <void*> make_bus_
+(define-stalin-ec <void*> make_busch_
   (lambda ()
-    (<void*> bus (tar_alloc_atomic heap (* (sizeof <float>) ,*rt-block-size*)))
-    (clear_bus_ bus)
-    (return bus)))
+    (<void*> busch (tar_alloc_atomic heap (* (sizeof <float>) ,*rt-block-size*)))
+    (return busch)))
 
 (define-stalin (make-bus)
-  (define bus (make_bus_))
+  (define bus (make-vector ,*stalin-max-bus-channels* NULL_))  
+  (vector-set! bus 0 (make_busch_))
+  (vector-set! bus 1 (make_busch_))
   (push! bus _all-buses))
-    
-(define-stalin-ec <float> read_bus_
-  (lambda ((<void*> bus)
+
+(define-stalin-ec <float> read_busch_
+  (lambda ((<void*> busch)
            (<int> time))
-    (return "((float*)bus)[time-block_time]")))
-(define-stalin (read-bus bus)
-  (read_bus_ bus _time))
+    (return "((float*)busch)[time-block_time]")))
 
-(define-stalin-ec <void> write_bus_
-  (lambda ((<void*> bus)
-           (<int> time)
-           (<float> val))
-    (+= "((float*)bus)[time-block_time]" val)))
+(define-stalin-macro (read-bus bus :optkey (channel 0))
+  (define busch (rt-gensym "busch"))
+  (if (and (number? channel)
+	   (< channel 2))
+      `(read_busch_ (vector-ref ,bus ,channel) _time)
+      `(let* ((,busch (vector-ref ,bus ,channel)))
+	 (if (is_NULL_ ,busch)
+	     0.0
+	     (read_busch_ ,busch _time)))))
 
-(define-stalin (write-bus bus val)
-  (write_bus_ bus _time val))
 
+(define-stalin-ec <void> write_busch_
+  (lambda ((<void*> busch)
+           (<int> time)
+           (<float> val))
+    (+= "((float*)busch)[time-block_time]" val)))
 
-;; out
-
-(define-stalin (out val)
-  (define coroutine _current-coroutine)
-  (write-bus (=> coroutine :bus) val))
+(define-stalin-macro (write-bus bus arg2 :optkey arg3)
+  (define busch (rt-gensym "busch"))
+  (define channel-name (rt-gensym "rt"))
+  (define bus-name (rt-gensym "bus"))
+  (let ((channel (if arg3 arg2 0))
+	(val     (if arg3 arg3 arg2)))
+    (if (and (number? channel)
+	     (< channel 2))
+	`(write_busch_ (vector-ref ,bus ,channel) _time ,val)
+	`(let* ((,channel-name ,channel)
+		(,bus-name ,bus)
+		(,busch (vector-ref ,bus-name ,channel-name)))
+	   (when (is_NULL_ ,busch)
+	     (set! ,busch (make_busch_))
+	     (vector-set! ,bus-name ,channel-name ,busch))
+	   (write_busch_ ,busch _time ,val)))))
+
+
+(define-stalin-macro (out arg1 :optkey arg2)
+  (define val-name (rt-gensym "val"))
+  (define bus (rt-gensym "bus"))
+  (if arg2
+      `(let ((coroutine _current-coroutine))
+	 (write-bus (=> coroutine :bus) ,arg1 ,arg2))
+      `(let* ((coroutine _current-coroutine)
+	      (,val-name ,arg1)
+	      (,bus (=> coroutine :bus)))
+	 (write-bus ,bus 0 ,val-name)
+	 (write-bus ,bus 1 ,val-name))))
 
 (define-stalin _main-bus (make-bus))
 
-(define-stalin-ec <void> bus_to_soundcard_
-  (lambda ((<void*> bus))
-    (<float*> sd2 (+ sounddata ,*rt-block-size*))
-    (for-each 0 ,*rt-block-size*
-              (lambda (i)
-                (set! sounddata[i] "((float*)bus)[i]")))
-    (for-each 0 ,*rt-block-size*
-              (lambda (i)
-                (set! sd2[i] "((float*)bus)[i]")))))
-
+(define-stalin-ec <void> busch_to_soundcard_
+  (lambda ((<void*> busch)
+	   (<int> ch))
+    (<float*> start (+ sounddata (* ch ,*rt-block-size*)))
+    (memcpy start busch (* ,*rt-block-size* (sizeof <float>)))))
+
+(define-stalin (bus_to_soundcard_ bus)
+  (busch_to_soundcard_ (vector-ref bus 0) 0)
+  (busch_to_soundcard_ (vector-ref bus 1) 1)
+  (let loop ((ch 2))
+    (when (< ch ,(min *stalin-max-bus-channels*
+		      *rt-num-output-ports*))
+      (let ((busch (vector-ref bus ch)))
+	(if (not (is_NULL busch))
+	    (busch_to_soundcard_ busch ch)))
+      (loop (1+ ch)))))
 
 ;; in
 
-(define-stalin-macro (in :rest code)
-  (define this-busk (symbol->keyword (rt-gensym "bus")))
-  (define this-soundholderk (symbol->keyword (rt-gensym "soundholder")))
-  (add-coroutine-slot this-busk #f)
-  (add-coroutine-slot this-soundholderk #f)
-
-  `(let ((coroutine _current-coroutine))
-     (when (= _time (=> coroutine :time)) ;; must check if this-busk exist as well. Here.
-
-       (when (not (=> coroutine ,this-busk))
-         (set! (=> coroutine ,this-busk) (make-bus))
-         (set! (=> coroutine ,this-soundholderk) (make-soundholder))
-         (let ((outer-bus (=> coroutine :bus))
-               (outer-soundholder (=> coroutine :soundholder)))
-           (set! (=> coroutine :bus) (=> coroutine ,this-busk))
-           (set! (=> coroutine :soundholder) (=> coroutine ,this-soundholderk))
-           (spawn
-             ,@code)
-           (set! (=> coroutine :bus) outer-bus)
-           (set! (=> coroutine :soundholder) outer-soundholder)
-           ))
-
-       (_sound-runner (=> coroutine ,this-soundholderk)))
-     
-     (read-bus (=> coroutine ,this-busk))
-     ))
-
-
+(define-stalin-macro (in code :optkey arg2 arg3)  ;; kont must be of the form (lambda (a b ...) ...) if arg2 is omitted
+  (fix-defines
+   (define kont        (cond (arg3 arg3)
+			     (else arg2)))
+   (define num-outputs (cond (arg3 arg2)
+			     (arg2 (length (cadr kont)))
+			     (else 1)))
+   ;;(define this-busk (symbol->keyword (rt-gensym "bus")))
+   ;;(define this-soundholderk (symbol->keyword (rt-gensym "soundholder")))
+   (define this-bus (rt-gensym "bus"))
+   (define this-soundholder (rt-gensym "soundholder"))
+   (define outer-bus (rt-gensym "outer-bus"))
+   (define outer-soundholder (rt-gensym "outer-soundholder"))
+
+   `(let ((coroutine _current-coroutine)
+	  (,this-bus (autovar ,(rt-gensym "bus") (make-bus) #f not)))
+      (if (= _time (=> coroutine :time))
+	  (_sound-runner (autovar ,(rt-gensym "soundholder")
+				  (let ((,outer-bus (=> coroutine :bus)) ;; dynamic scoping of bus and soundholder.
+					(,outer-soundholder (=> coroutine :soundholder))
+					(,this-soundholder (make-soundholder)))
+				    (set! (=> coroutine :bus) ,this-bus)
+				    (set! (=> coroutine :soundholder) ,this-soundholder)
+				    (spawn ;; Does this one somehow run immediately? It should, but it doesn't seem like it does. Hmm.
+				      ,code)
+				    (set! (=> coroutine :bus) ,outer-bus)
+				    (set! (=> coroutine :soundholder) ,outer-soundholder)
+				    ,this-soundholder)
+				  #f 
+				  not)))
+      
+      ,(cond ((and arg2 arg3)
+	      `(,kont ,@(let loop ((ch 0))
+			  (if (= num-outputs ch)
+			      '()
+			      (cons `(read-bus ,this-bus ,ch)
+				    (loop (1+ ch)))))))
+	     (arg2
+	      `(let ,(let loop ((ch 0)
+				(vars (cadr kont)))
+		       (if (null? vars)
+			   '()
+			   (cons (list (car vars)
+				       `(read-bus ,this-bus ,ch))
+				 (loop (1+ ch)
+				       (cdr vars)))))
+		 ,@(cddr kont)))
+	     (else
+	      `(read-bus ,this-bus))))
+      ))
+  
+  
 #!
-
+(pretty-print (stalin-macroexpand '(in (hepp) (lambda (a b c) (gakk)))))
+(pretty-print (stalin-macroexpand '(in (hepp) 4 gakk)))
 ;;example:
 (<rt-stalin>
  (define (osc)
@@ -2491,6 +2832,75 @@
 
 
 
+;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
+;;;;;;;;;;;;; Extra coroutine variables ;;;;;;;;;;;;;;;;;;;;;;;;;
+;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
+
+;; autovar can be redefined by user, autovar_ can not.
+(define-stalin-macro (autovar name val default-false check-if-default-is-false-func)
+  `(autovar_ ,name ,val ,default-false ,check-if-default-is-false-func))
+
+(define (stalin-fix-autovars-find-autovars code kont)
+  (define autovars '())
+  (define coroutine-pos (1- (/ (length coroutine-slots) 2)))
+  (let ((code (let loop ((code code))
+		(schemecodeparser code
+				  :symbolhandler
+				  (list 'autovar_
+					(labamba (expr)
+					  (let ((name (loop (nth 1 expr)))
+						(val (loop (nth 2 expr)))
+						(default-false (loop (nth 3 expr)))
+						(check-if-default-is-false-func (loop (nth 4 expr)))
+						(ret (rt-gensym "ret")))
+					    (push! (list name default-false) autovars)
+					    (inc! coroutine-pos 1)
+					    `(cond ((,check-if-default-is-false-func (  (primitive-procedure structure-ref coroutine ,coroutine-pos)
+											_current-coroutine))
+						    (let ((,ret ,val))
+						      (   (primitive-procedure structure-set! coroutine ,coroutine-pos)
+							  _current-coroutine
+							  ,ret)
+						      ,ret))
+						   (else
+						    (   (primitive-procedure structure-ref coroutine ,coroutine-pos)
+							_current-coroutine))))))))))
+    (kont (reverse autovars) code)))
+
+(define (stalin-fix-autovars-fix-coroutines autovars code)
+  (define extra-coroutine-args (map cadr autovars))
+  (schemecodeparser code
+
+		    ;; Add additional arguments to make-coroutine-internal
+		    :symbolhandler
+		    (list 'make-coroutine-internal
+			  (lambda (expr)
+			    `(,@expr ,@extra-coroutine-args)))
+
+		    ;; redefine make-coroutine
+		    :use-customsymbolhandler?
+		    (lambda (expr)
+		      (and (eq? (car expr) 'define)
+			   (eq? (cadr expr) 'make-coroutine)))
+		    :customsymbolhandler
+		    (lambda (expr)
+		      (define argnames (append (map keyword->symbol (%filter keyword? coroutine-slots))
+					       (map car autovars)))
+		      `(define make-coroutine
+			 (lambda ,argnames
+			   ((primitive-procedure make-structure coroutine ,(length argnames))
+			    ,@argnames))))))
+
+
+
+(define (stalin-fix-autovars code)
+  (stalin-fix-autovars-find-autovars code
+				     stalin-fix-autovars-fix-coroutines))
+
+
+#!
+(pretty-print (stalin-macroexpand '(autovar rt_gen_7 (make-oscil #:freq 400) NULL_ is_NULL)))
+!#
 
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 ;;;;;;;;;;;;; Generate stalin code ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
@@ -2584,8 +2994,9 @@
                                               (find-stalin-code-outcomes body))
                                         ret)))
 
+                              ;; named let
                               ((and (eq? 'let (car expr))
-                                    (not (pair? (cadr expr))))
+                                    (symbol? (cadr expr)))
                                (for-each loop (map cdr (nth 2 expr))) ;; arguments.
                                (loop (nth-cdr 3 expr))
                                (push! (list (nth 1 expr)
@@ -2607,7 +3018,6 @@
                                (loop (cddr expr)))))))
   ret)
 
-
 #!
 (find-stalin-func-returns '((let loop ()
                               (define ret (lambda ()
@@ -3173,7 +3583,7 @@
          code))))
 
 #!
-(pretty-print (stalin-remove-call/cc
+(pretty-print (stalin-remove-call/cc-recursively
                '(lambda ()
                   (lowlevel_debug "starting")
                   (let loop ()
@@ -3186,7 +3596,7 @@
                     (lowlevel_debug "one second later")
                     (loop)))))
 
-(pretty-print (stalin-remove-call/cc
+(pretty-print (stalin-remove-call/cc-recursively
                '(lambda ()
                   (lowlevel_debug "starting")
                   (let loop ()
@@ -3203,7 +3613,7 @@
 
 
 
-(pretty-print (stalin-remove-call/cc
+(pretty-print (stalin-remove-call/cc-recursively
                '(lambda ()
                   (lowlevel_debug "starting")
                   (call-with-current-continuation
@@ -3521,7 +3931,7 @@
                               sym)))
                       :use-customsymbolhandler?
                       (lambda (expr)
-                        (memq (car expr) '(define lambda let let* letrec)))
+                        (memq (car expr) '(define lambda let let* letrec primitive-procedure foreign-procedure)))
                       :customsymbolhandler
                       (lambda (expr)
                         (cond (#f #f)
@@ -3604,6 +4014,11 @@
                                             varlist
                                             renameds))))
 
+			      ;; primitive-procedure, foreign-procedure, etc.
+			      ;; Do not uniqify anything inside those operators.
+			      (else
+			       expr)
+
                               )))))
 
 #!
@@ -3651,30 +4066,32 @@
 
 ;; (define (a) (+ a b) (define c 2) c) -> (define (a) (+ a b) (letrec ((c 2)) c))
 (define (stalin-fix-internal-defines code)
-  (c-display "fix-internal-defines entry")
-  (map (lambda (code)
-         (let das-loop ((code code)
-                        (level 0))
-           (schemecodeparser  code
-                              :blockhandler
-                              (lambda (expr)
-                                (let loop ((expr expr))
-                                  (cond ((null? expr)
-                                         '())
-                                        ((= 0 level)
-                                         (das-loop expr 1))
-                                        (else
-                                         (let ()
-                                           (define expr0 (car expr))
-                                           (if (and (pair? expr0)
-                                                    (eq? 'define (car expr0)))
-                                               (let ()
-                                                 (das-loop `((letrec ((,(nth 1 expr0) ,(nth 2 expr0)))
-                                                               ,@(cdr expr)))
-                                                           (1+ level)))
-                                               (cons (das-loop expr0 (1+ level))
-                                                     (loop (cdr expr))))))))))))
-       code))
+  (c-display "fix-internal-defines entry" code)
+  (if (not (list? code))
+      code
+      (map (lambda (code)
+	     (let das-loop ((code code)
+			    (level 0))
+	       (schemecodeparser  code
+				  :blockhandler
+				  (lambda (expr)
+				    (let loop ((expr expr))
+				      (cond ((null? expr)
+					     '())
+					    ((= 0 level)
+					     (das-loop expr 1))
+					    (else
+					     (let ()
+					       (define expr0 (car expr))
+					       (if (and (pair? expr0)
+							(eq? 'define (car expr0)))
+						   (let ()
+						     (das-loop `((letrec ((,(nth 1 expr0) ,(nth 2 expr0)))
+								   ,@(cdr expr)))
+							       (1+ level)))
+						   (cons (das-loop expr0 (1+ level))
+							 (loop (cdr expr))))))))))))
+	   code)))
 #!
 (stalin-fix-internal-defines '((define (a) (+ a b) (define c 2) c)))
 ; -> (define (a) (+ a b) (letrec ((c 2)) c))
@@ -3697,6 +4114,7 @@
 
 ;; only "(asdasf):-ms" infixes, not "asdf:-ms" infixes.
 (define (fix-stalin-infix code)
+  ;;(c-display "fix-infix" code)
   (cond ((null? code) '())
         ((not (pair? code)) code)
         (else
@@ -3714,7 +4132,7 @@
                        (,(<_> 'infix (keyword->symbol (car term)))
                         ,(last first))
                        ,@(cdr term))))
-                   (else
+                   (else		    
                     (set! first (append first (list (car term))))
                     (loop (cdr term)))))))))
 #!
@@ -3731,7 +4149,7 @@
                                            sym)
                                           ((and (char=? #\: (car string))
                                                 (char=? #\- (cadr string)))
-                                           (stalin-super-generate
+                                           (stalin-super-expanded
                                             `(,(string->symbol (<-> "infix-" (list->string (cddr string))))
                                               ,(let ((string (list->string (reverse! first))))
                                                  (or (string->number string)
@@ -3826,62 +4244,89 @@
    (loop)))
 !#
 
+;; Returns an association list of dependencies suitable for topological-sort.
+(define (stalin-find-dependencies-0 result
+                                    funclist
+                                    find-dependencies)
+  (cond ((null? funclist)
+         result)
+        ((assq (car funclist) result)
+         (stalin-find-dependencies-0 result
+                                     (cdr funclist)
+                                     find-dependencies))
+        (else
+         (let ((deps (find-dependencies (car funclist))))
+           (stalin-find-dependencies-0 (cons (cons (car funclist) deps)
+                                             result)
+                                       (append (cdr funclist) deps)
+                                       find-dependencies)))))
 
-(define* (stalin-super-generate code :key (include-make-coroutine #f))
+
+;; returns a sorted list of dependencies.
+;; '(func1 funcb) -> '(funcc funcd func1 funcb)
+(define (stalin-find-dependencies root-dependencies find-dependencies)
+  (reverse
+   (topological-sort
+    (stalin-find-dependencies-0 '()
+                                root-dependencies
+                                find-dependencies))))
+
+#!
+(stalin-find-dependencies '(_queue _coroutine-dummy get-first-coroutine-in-queue)
+			  (lambda (funcname)
+			    (find-stalin-funcs (stalin-super-expanded (get-stalin-func funcname)))))
+
+(stalin-find-dependencies '(make-bus bus _main-bus read-bus)
+			  (lambda (funcname)
+			    (find-stalin-funcs (stalin-super-expanded (get-stalin-func funcname)))))
+
+(stalin-find-dependencies (reverse '(make-bus bus _main-bus read-bus))
+			  (lambda (funcname)
+			    (find-stalin-funcs (stalin-super-expanded (get-stalin-func funcname)))))
+!#
+
+
+(define* (stalin-super-expanded code)
   (stalin-fix-defines 
    (fix-stalin-various
     (stalin-macroexpand
      (fix-stalin-infix
-      code)
-     :include-make-coroutine include-make-coroutine))))
+      code)))))
+
 
 ;; Expands macros and include functions and variables which the code depends on,
 ;; all recursively. (careful with macros since its applied to all included code!)
 (define (generate-stalin-code0 code)
 
-  ;; memoized (lambda (funcname) `(define ,funcname ,(stalin-macroexpand (get-stalin-func funcname))))
-  (define get-expanded-code
+  ;; memoized (lambda (funcname) `(define ,funcname ,(stalin-super-expanded (get-stalin-func funcname))))
+  (define get-super-expanded-from-funcname
     (let ((expanded '()))
       (lambda (funcname)
         (let ((expanded (assq funcname expanded)))
           (if expanded
               (cadr expanded)
-              (let ((ret (stalin-super-generate (get-stalin-func funcname) :include-make-coroutine #t)))
+              (let ((ret (stalin-super-expanded (get-stalin-func funcname))))
                 (push! (list funcname ret)
                        expanded)
                 ret))))))
   
-  (define (find-dependencies trace code)
-    (define funcs (find-stalin-funcs code))
-    ;;(c-display "find" code)
-    ;;(c-display "funcs" funcs)
-    (if (null? funcs)
-        '(#f)
-        (flatten (map (lambda (func)
-                        (if (memq func trace)
-                            '(#f) ;; cyclic dependency
-                            (list (find-dependencies (cons func trace)
-                                                     (get-expanded-code func))
-                                  func)))
-                      funcs))))
+  (let* ((expanded (stalin-super-expanded code ))
 
-  (reset-coroutine-struct!) ;; coroutine-suff!
-  
-  (let* ((expanded (stalin-super-generate code))
-         (no-use (begin  ;; coroutine-suff!
-                   (redefine-coroutine-struct!)                  
-                   (set! expanded (stalin-macroexpand expanded :include-make-coroutine #t))
-                   ;;(pretty-print expanded)
-                   ))
-         (dependencies
-          (delete-duplicates (delete #f (find-dependencies '() expanded) eq?)
-                             eq?)))
-    ;;(pretty-print dependencies)
-    (append (map get-expanded-code dependencies)
-            expanded)))
+         (dependencies (stalin-find-dependencies (find-stalin-funcs expanded)
+						 (lambda (funcname)
+						   (find-stalin-funcs (get-super-expanded-from-funcname funcname))))))
+    
+    (pretty-print dependencies)
+    (c-display "NOW IM HERE")
+    
+    (append (map get-super-expanded-from-funcname dependencies)
+	    expanded)))
+	
 
 
 #!
+(find-stalin-funcs (stalin-super-expanded (get-stalin-func 'read-bus)))
+
 (define-stalin a 0)
 (define-stalin b a)
 (define-stalin c (+ a b c));b a))
@@ -3890,14 +4335,15 @@
 !#
   
 
-(define (generate-stalin-code code)
+(define (generate-stalin-code expanded-code)
   (define lotsofcode (stalin-uniqify-variables
-                      (stalin-fix-internal-defines
-                       (generate-stalin-code0 code))))
+		      (stalin-fix-internal-defines
+		       (stalin-fix-autovars
+			expanded-code))))
   (stalin-add-health-checks
    (stalin-remove-dead-code-recursively ;; Second call. stalin-remove-call/cc might have added dead code
     (stalin-remove-call/cc-recursively
-     (stalin-remove-dead-code-recursively
+     (stalin-remove-dead-code-recursively      
       lotsofcode)))))
 
    
@@ -3923,7 +4369,7 @@
 
 
 ;; Add: -copt -freg-struct-return ?
-;; The stalin optino "-df" must be added to ensure proper tail calls.
+;; The stalin option "-df" must be added to ensure proper tail calls.
 (define (compile-stalin-file basename)
   ;;(define command (<-> "stalin -On -no-clone-size-limit  -split-even-if-no-widening  -Ob -Om -Or -Ot -c " basename ".scm"))
   ;;(define command (<-> "stalin -On -no-clone-size-limit  -Ob -Om -Or -Ot -c " basename ".scm"))
@@ -3932,6 +4378,7 @@
   ;;(define command (<-> "stalin -On -clone-size-limit 0 -no-escaping-continuations -c " basename ".scm"))
   ;;(define command (<-> "stalin -fully-convert-to-CPS -On -clone-size-limit 0 -c " basename ".scm"))
   ;;(define command (<-> "stalin -On -no-clone-size-limit -split-even-if-no-widening  -c " basename ".scm"))
+  ;;(define command (<-> "stalin -df -On -clone-size-limit 0 -c " basename ".scm"))
   (define command (<-> "stalin -df -On -clone-size-limit 0 -c " basename ".scm"))
   (delete-at-exit (<-> basename ".c"))
   (c-display command)
@@ -3968,12 +4415,35 @@
     (fix-stalin-c-source inname outname)
     (c-display "inname" inname)
     (cont basename
-          outname)))
+          outname
+	  )))
 
 #!
 (get-stalin-c-file (schemecode->file (generate-stalin-code0 '((display (+ 2 3))(newline)))))
 !#
 
+(define *cached-stalin-c-files* (make-hash-table 997))
+
+(define (clear-stalin-cache!)
+  (set!  *cached-stalin-c-files* (make-hash-table 997)))
+#!
+(clear-stalin-cache!)
+!#
+
+(define (get-cached-stalin-key expanded-code)
+  (list *rt-opt-stack-checks*
+	*rt-opt-cpu-checks*
+	expanded-code))
+
+(define (add-cached-stalin-c-file expanded-code basename c-file ec-funcs)
+  (hash-set! *cached-stalin-c-files* (get-cached-stalin-key expanded-code) (list basename c-file ec-funcs)))
+
+(define (get-cached-stalin-c-file expanded-code cont)
+  (define cached (hash-ref *cached-stalin-c-files* (get-cached-stalin-key expanded-code)))
+  (if cached
+      (apply cont cached)
+      #f))
+
 #!
 (define (link-stalin-file c-file)
   (define o-file (<-> c-file ".o"))
@@ -4019,11 +4489,11 @@
   <void*> freefunc)
 
 
-(define (link-stalin-file basename c-file program)
+(define (link-stalin-file basename c-file ec-funcs)
   (c-display "c-file:" c-file)
   (apply eval-c-non-macro
          `(,(<-> "-I" snd-header-files-path " -fno-strict-aliasing -I/home/kjetil/site/include" " -lpcl")
-           #f
+           #f ;c-file
 
            "#include <jack/jack.h>"
            "#include <jack/ringbuffer.h>"
@@ -4088,6 +4558,7 @@
                                                         ,*rt-num-output-ports*)))
             (fprintf stderr (string "alloc end\\n")))
 
+	   
            (<void> clean_sounddata (lambda ()
                                      (memset sounddata 0 (* (sizeof <float>) 
                                                             ,*rt-block-size*
@@ -4106,7 +4577,7 @@
                                ;;    (+= data->val val))
                                ;;(set! data->last_written_to block_time)
                                ))
-           (<void> sounddata_to_bus (lambda ((<int> startframe)
+           (<void> sounddata_to_bus (lambda ((<int> startframe) ;; This bus is an "RT" bus, not a stalin bus.
                                              (<int> endframe))
                                       (for-each 0 ,*rt-num-output-ports*
                                                 (lambda (ch)
@@ -4116,6 +4587,10 @@
                                                                     "sounddata[ch*" (number->string *rt-block-size*)
                                                                     "+framenum])")))))))
 
+           (public
+            (<void-*> get_last_rt_heap (lambda ()
+                                         (return heap))))
+           
            (run-now
             (fprintf stderr (string "new heap start\\n"))
             (set! heap (tar_create_heap))
@@ -4153,7 +4628,7 @@
                                               (set! gc_uncollectable_mem ret)
                                               (return ret+1)))
            
-           ,@(get-stalin-ec-funcs program)
+           ,@ec-funcs
            
            (<void> health_exit (lambda ()
                                  (rt_debug (string ,(<-> "Scheme file: \\\"" basename ".scm\\\"")))
@@ -4165,10 +4640,14 @@
                             (<char*> function_name))
                      (rt_debug (string "%d: %s") num function_name)))
 
+	   (<int> cpu_check_counter 1)
+
            (<int> check_health_internal
                   (lambda ()
                     (<char*> das_stack_bot (cast <char*> (rt_get_stack_address)))
-                    
+		    (if (== cpu_check_counter (* 2 4096)) ;; (jack_get_time) sometimes takes a lot of time. Can't call it that often.
+			(set! cpu_check_counter 0)
+			cpu_check_counter++)
                     (cond ((and ,(if *rt-opt-stack-checks* 1 0)
                                 (< das_stack_bot
                                    (- stack_top ,*stalin-stack-limit*)))
@@ -4177,16 +4656,20 @@
                            (return 1))
                           ((and ,(if *rt-opt-cpu-checks* 1 0)
                                 (> block_enter_time 0)
+				(== cpu_check_counter 0)
                                 (> (jack_get_time)
-                                   (+ block_enter_time ,(c-integer (* 1
-                                                                      (/ (* 1000000 *rt-block-size*)
-                                                                         (rte-samplerate)))))))
-                           (rt_debug (string
-                                      ,(<-> "Using too much CPU. Stopping instrument in case this is an endless loop."
-                                            "In case not, use the :runtime-checks option to turn off off safety checks,\\n"
-                                            "programs usually runs magnitudes faster when doing so.\\n\\nLast visited: (newest->oldest)")))
-                           (return 2))
-                          (else
+                                   (+ block_enter_time 1000000)));,(c-integer (* 1
+                                                                  ;    (/ (* 1000000 *rt-block-size*)
+                                                                   ;      (rte-samplerate)))))))
+			   (rt_debug (string
+                                      ,(<-> "Using too much CPU. (%fms-%fms=%fms) Stopping instrument in case this is an endless loop."
+                                            "In case not, it might help to turn off runtime checks using the :runtime-checks option for <rt-stalin.\\n"))
+				     (cast <float> (/ (cast <double> (jack_get_time)) 1000.0))
+				     (cast <float> (/ (cast <double> block_enter_time) 1000.0))
+				     (- (cast <float> (/ (cast <double> (jack_get_time)) 1000.0))
+					(cast <float> (/ (cast <double> block_enter_time) 1000.0))))
+			   (return 2))
+			  (else
                            (return 0)))))
            
            "#define fprintf(a,...) rt_debug(__VA_ARGS__)"
@@ -4215,7 +4698,7 @@
                                     (set! block_enter_time (- (jack_get_time)
                                                               (/ (* 1000000 startframe)
                                                                  ,(rte-samplerate))))
-                                    (clean_sounddata)
+                                    (clean_sounddata)  ;; Is this really necessary?
                                     (set! first_run 0))
 
                                   (tar_before_using_heap heap)
@@ -4245,14 +4728,14 @@
 
                                   (if (tar_after_using_heap heap)
                                       (when (== 0 remove_me)
-                                        (rt_debug (string "data: %d, stack: %d %p %p, mem_used: %d/%d")
-                                                  (abs (- end_dyn start_dyn))
-                                                  (abs (- stack_top stack_bot))
-                                                  stack_bot
-                                                  stack_top
-                                                  (tar_get_used_mem heap)
-                                                  (tar_get_used_atomic_mem heap)
-                                                  )
+                                        ;(rt_debug (string "data: %d, stack: %d %p %p, mem_used: %d/%d")
+                                         ;         (abs (- end_dyn start_dyn))
+                                          ;        (abs (- stack_top stack_bot))
+                                           ;       stack_bot
+                                            ;      stack_top
+                                             ;     (tar_get_used_mem heap)
+                                              ;    (tar_get_used_atomic_mem heap)
+                                               ;   )
                                         
                                         (tar_add_root_concurrently heap start_dyn end_dyn) ; data
                                         ;;(tar_add_root heap &dynstart &dynend) ;; This might work, but performance-vice it shouldn't matter. Probably better to be safe and just use start_dyn and end_dyn.
@@ -4318,11 +4801,12 @@
                                          (fprintf stderr (string "Hepp, freeing stalin\\n"))
                                          (co_delete dsp_coroutine)
 					 (scm_gc_unregister_collectable_memory heap ,(+ (* *tar-nonatomic-heap-size* 2) (* *tar-max-mem-size* 4)) (string "rollendurch/stalin heap"))
-					 (tar_delete_heap heap true) ;; tar_init_block is always called
+					 ;;(tar_delete_heap heap true) ;; tar_init_block is always called
                                          ;;(if (> rt_engine->num_procfuncs 0)
                                          ;;    (tar_delete_heap heap true)
                                          ;;    (tar_delete_heap heap false))
                                          (free sounddata)
+                                         (fprintf stderr (string "Hepp, stalin freed\\n"))
                                          )))
            
            (public
@@ -4353,31 +4837,58 @@
 
 (define last-stalin #f)
 
+(define stalin-extra-init-code '())
+
 (define (<rt-stalin-do> code)
+
   (set! last-stalin code)
+  (set! stalin-extra-init-code '())
+  (rt-gensym-reset)
+
   (catch 'compilation-error
          (lambda ()
            (fix-defines
-            (define generated (generate-stalin-code
-                               `( (spawn
-                                    ,@code)
-                                  (insert-coroutine-in-queue! _sound-coroutine
-                                                              _next-scheduled-time
-                                                              3) ;; block priority. (lowest)
-                                  ((=> coroutine:_current-coroutine :continuation)))))
-            
-            ;;(c-display "generated" generated)
-            ;;(check-stalin-syntax generated)
-            (get-stalin-c-file (schemecode->file generated)
-                               (lambda (basename c-file)
-                                 (define funcs (link-stalin-file basename c-file generated))
-                                 (if funcs
-                                     (let ()
-                                       (define realtime (<realtime> (car funcs) (cadr funcs) '()))
-                                       (-> realtime play)
-                                       realtime)
-                                     #f)
-                                 ))))
+
+	    (define expanded-code 
+	      (let ((main-code (generate-stalin-code0
+				`(
+				  
+                		     ;;; Init variables which could not be set directly because of circular dependencies.
+				  (set! _coroutine-dummy (make-coroutine :soundholder _main-soundholder :bus _main-bus :parent #f))
+				  (set! _queue (make-vector ,*stalin-queue-max-size* _coroutine-dummy))
+				  
+				  (spawn
+				    ,@code)
+				  (insert-coroutine-in-queue! _sound-coroutine
+							      _next-scheduled-time
+							      3) ;; block priority. (lowest)
+				  ((=> coroutine:_current-coroutine :continuation))))))
+		(append stalin-extra-init-code main-code)))
+	    
+	    (call/cc
+	     (lambda (return)
+
+	       (define (link-and-run basename c-file ec-funcs)		 
+		 (define funcs (link-stalin-file basename c-file ec-funcs))
+		 (return (if funcs
+			     (let ()
+			       (define realtime (<realtime> (car funcs) (cadr funcs) '()))
+			       (-> realtime play)
+			       realtime)
+			     #f)))
+	       
+	       (get-cached-stalin-c-file expanded-code link-and-run)
+
+	       (let ()
+		 (define generated (generate-stalin-code expanded-code))
+		 ;;(c-display "generated" generated)
+		 ;;(check-stalin-syntax generated)
+		 (get-stalin-c-file (schemecode->file generated)
+				    (lambda (basename c-file)
+				      (define ec-funcs (get-stalin-ec-funcs generated))
+				      (add-cached-stalin-c-file expanded-code basename c-file ec-funcs)
+				      (link-and-run basename c-file ec-funcs))))))))
+
          (lambda x
            #f)))
 
diff -ur snd-10/rt-various.c snd-10-new/rt-various.c
--- snd-10/rt-various.c	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/rt-various.c	2010-11-18 01:12:59.050884997 +0100
@@ -9,6 +9,7 @@
 #include <stdarg.h>
 #include <errno.h>
 #include <sched.h>
+#include <pthread.h>
 
 #include "rt-various.h"
 
@@ -30,7 +31,7 @@
        || (!isalpha(temp[0]))
        )
       if(!strcmp("#include <gc.h>\n",temp))
-        fputs("#include <rt-various.h>\n",out);
+        fputs("#include <rt-gc.h>\n",out);
       else
         fputs(temp,out);
     else{
@@ -59,16 +60,17 @@
 
 /* Rollendurchmesserzeitsammler stuff. */
 
-
-static pid_t mainpid=0;
+static bool rollendurch_inited=false;
+static pthread_t main_thread;
 
 void init_rollendurchmesserzeitsammler(int a,int b,int c,int d,float e){
-  mainpid=getpid();
+  main_thread = pthread_self();
   tar_init(a,
 	   b,
 	   c,
            d,
            e);
+  rollendurch_inited = true;
 }
 
 
@@ -104,6 +106,11 @@
 static tar_heap_t *clm_tar_heap=NULL;
 static error_func_t clm_error_func=NULL;
 
+static int is_nonrealtime_thread(void){
+  // printf("%p, %d, %d\n",clm_tar_heap, rollendurch_inited, pthread_equal(pthread_self(),main_thread));
+  return (clm_tar_heap==NULL || rollendurch_inited==false || pthread_equal(pthread_self(),main_thread)!=0);
+}
+
 tar_heap_t *clm_set_tar_heap(tar_heap_t *new_heap){
     tar_heap_t *ret=clm_tar_heap;
     clm_tar_heap=new_heap;
@@ -135,25 +142,28 @@
 
 
 void* clm_calloc_atomic(int num,size_t size,const char* what){
-  if(clm_tar_heap==NULL || mainpid==0 || getpid()==mainpid){
+  if(num*size==0)
+    return NULL;
+  if(is_nonrealtime_thread()){
     return calloc(num,size);
   }else{
     void *ret=tar_alloc_atomic(clm_tar_heap,num*size);
-    if(ret==NULL){
+    //memset(ret,0,num*size);
+    //printf("heap: %p. Size: %d, ret: %p\n",clm_tar_heap, num*size,ret);
+    if(ret==NULL && num>0 && size>0){
       rt_mus_error(0,"clm.c: out of memory. (%s)",what);
     }
-    memset(ret,0,num*size);
     return ret;
   }
 }
 
 
 void* clm_calloc(int num,size_t size,const char* what){
-  if(clm_tar_heap==NULL || mainpid==0 || getpid()==mainpid){
+  if(is_nonrealtime_thread()){
     return calloc(num,size);
   }else{
     void *ret=tar_alloc(clm_tar_heap,num*size);
-    if(ret==NULL){
+    if(ret==NULL && num>0 && size>0){
       rt_mus_error(0,"clm.c: out of memory. (%s)",what);
     }
     return ret;
@@ -161,11 +171,11 @@
 }
 
 void* clm_malloc_atomic(size_t size,const char* what){
-  if(clm_tar_heap==NULL || mainpid==0 || getpid()==mainpid){
+  if(is_nonrealtime_thread()){
     return malloc(size);
   }else{
     void *ret=tar_alloc_atomic(clm_tar_heap,size);
-    if(ret==NULL){
+    if(ret==NULL && size>0){
       rt_mus_error(0,"clm.c: out of memory. (%s)",what);
     }
     return ret;
@@ -173,11 +183,11 @@
 }
 
 void* clm_malloc(size_t size,const char* what){
-  if(clm_tar_heap==NULL || mainpid==0 || getpid()==mainpid){
+  if(is_nonrealtime_thread()){
     return malloc(size);
   }else{
     void *ret=tar_alloc(clm_tar_heap,size);
-    if(ret==NULL){
+    if(ret==NULL && size>0){
       rt_mus_error(0,"clm.c: out of memory. (%s)",what);
     }
     return ret;
@@ -185,7 +195,7 @@
 }
 
 void* clm_realloc(void* old,size_t newsize){
-  if(clm_tar_heap==NULL || mainpid==0 || getpid()==mainpid){
+  if(is_nonrealtime_thread()){
     return realloc(old,newsize);
   }else{
     return memcpy(clm_malloc(newsize,"realloc"),old,newsize);
@@ -194,7 +204,7 @@
 
 
 void clm_free(void* p){
-  if(clm_tar_heap==NULL || mainpid==0 || getpid()==mainpid){
+  if(is_nonrealtime_thread()){
     free(p);
   }
 }
diff -ur snd-10/rt-various.h snd-10-new/rt-various.h
--- snd-10/rt-various.h	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/rt-various.h	2010-11-18 01:11:33.141884777 +0100
@@ -17,21 +17,8 @@
 // disabled for now since the returned mem can be used to store void* pointers.
 //#define GC_malloc_atomic(size) tar_alloc_atomic(heap,size)
 
-#define GC_malloc_atomic(size) tar_alloc(heap,size)
-
-#define GC_malloc(size) tar_alloc(heap,size)
-
-// This one too.
-//#define GC_malloc_atomic_uncollectable(size) tar_malloc_atomic_uncollectable(size)
-#define GC_malloc_atomic_uncollectable(size) tar_alloc(heap,size)
-
-#define GC_malloc_uncollectable(size) tar_alloc_uncollectable(size)
-
-// Hmm, only works if its atomic uncollectable mem. Not good.
-//#define GC_free(mem) tar_free_atomic_uncollectable(mem)
-// Same reason. Just make it a dummy:
-#define GC_free(mem) /* */
-
+#if 0
+#endif
 
 // In clm.c returns the old heap.
 //tar_heap_t *clm_set_tar_heap(tar_heap_t *new_heap);
diff -ur snd-10/s7.c snd-10-new/s7.c
--- snd-10/s7.c	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/s7.c	2010-11-18 01:12:55.333978295 +0100
@@ -74,10 +74,9 @@
  *        symbol-calls if profiling is enabled
  *        stacktrace, trace and untrace, __func__, macroexpand
  *        strings are set-applicable (like vectors)
- *        length accepts vectors, strings, hash-tables
  *
  *   things I ought to add/change:
- *        generic: fill!, copy, reverse! null? find(-if) etc from CL? for-each|map over vectors?
+ *        length should work on vectors and strings [fill!, copy, reverse! null? find(-if) etc from CL? for-each|map over vectors?]
  *          also for new-types -- would need length field and copy/fill
  *          (what about files? numbers? -- integer-length, bignum-precision etc)
  *        lists should be (set-)applicable (*-ref|set! are ugly and pointless)
@@ -200,12 +199,6 @@
    */
 #endif
 
-#ifndef WITH_ENCAPSULATION
-  #define WITH_ENCAPSULATION 0
-/* an experiment */
-/* valgrind timing tests indicate this adds less than .01% in non-encap cases (i.e. 2 of 31000) */
-#endif
-
 
 
 /* -------------------------------------------------------------------------------- */
@@ -232,7 +225,6 @@
  *    eval
  *    quasiquote
  *    threads
- *    encapsulators
  *    gmp, mpfr, mpc support
  *    s7 init
  */
@@ -303,9 +295,6 @@
 	      OP_TRACE_RETURN, OP_ERROR_HOOK_QUIT,
 	      OP_MAX_DEFINED} opcode_t;
 
-#define NUM_SMALL_INTS 256
-/* this needs to be at least OP_MAX_DEFINED */
-
 typedef enum {TOKEN_EOF, TOKEN_LEFT_PAREN, TOKEN_RIGHT_PAREN, TOKEN_DOT, TOKEN_ATOM, TOKEN_QUOTE, TOKEN_DOUBLE_QUOTE, 
 	      TOKEN_BACK_QUOTE, TOKEN_COMMA, TOKEN_AT_MARK, TOKEN_SHARP_CONST, TOKEN_VECTOR} token_t;
 
@@ -499,10 +488,6 @@
   bool *gc_off;                       /* if true, the GC won't run */
   bool *tracing;                      /* if tracing, each function on the *trace* list prints its args upon application */
   long *gensym_counter;
-
-#if WITH_ENCAPSULATION
-  s7_pointer encapsulators;
-#endif
   
   #define INITIAL_STRBUF_SIZE 1024
   int strbuf_size;
@@ -598,11 +583,6 @@
  *   the size increase is more important.
  */
 
-#if WITH_ENCAPSULATION
-#define T_SETTER                      (1 << (TYPE_BITS + 5))
-#define is_setter(p)                  ((typeflag(p) & T_SETTER) != 0)
-#endif
-
 #define T_OBJECT                      (1 << (TYPE_BITS + 6))
 
 #define T_FINALIZABLE                 (1 << (TYPE_BITS + 7))
@@ -625,7 +605,7 @@
 #define is_eternal(p)                 ((typeflag(p) & T_ETERNAL) != 0)
 /* an eternal object is a cons whose "line_number" is actually the global environment vector location (i.e. a symbol table entry) */
 
-#define UNUSED_BITS                   0xf0000000
+#define UNUSED_BITS                   (0xf0000000 | (1 << (TYPE_BITS + 5)))
 
 #if HAVE_PTHREADS
 #define set_type(p, f)                typeflag(p) = ((typeflag(p) & T_GC_MARK) | (f) | T_OBJECT)
@@ -752,9 +732,6 @@
 #define is_c_object(p)                (type(p) == T_C_OBJECT)
 #define c_object_type(p)              p->object.fobj.type
 
-#if WITH_ENCAPSULATION
-#define is_encapsulating(Sc)          ((Sc)->encapsulators != sc->NIL)
-#endif
 
 #define NUM_INT      0
 #define NUM_RATIO    1
@@ -1275,10 +1252,6 @@
   S7_MARK(sc->input_port_stack);
   S7_MARK(sc->output_port);
   S7_MARK(sc->error_port);
-
-#if WITH_ENCAPSULATION
-  S7_MARK(sc->encapsulators);
-#endif
   
   S7_MARK(sc->protected_objects);
   {
@@ -1781,7 +1754,7 @@
 
 static s7_pointer new_frame_in_env(s7_scheme *sc, s7_pointer old_env) 
 { 
-  return(s7_cons(sc, sc->NIL, old_env));
+  return(s7_immutable_cons(sc, sc->NIL, old_env));
 } 
 
 
@@ -1791,7 +1764,7 @@
   slot = s7_immutable_cons(sc, variable, value); 
   if (s7_is_vector(car(env))) 
     vector_element(car(env), symbol_location(variable)) = s7_immutable_cons(sc, slot, vector_element(car(env), symbol_location(variable)));
-  else car(env) = s7_cons(sc, slot, car(env));
+  else car(env) = s7_immutable_cons(sc, slot, car(env));
   return(slot);
 } 
 
@@ -2882,7 +2855,7 @@
 s7_pointer s7_make_integer(s7_scheme *sc, s7_Int n) 
 {
   s7_pointer x;
-  if ((n >= 0) && (n < NUM_SMALL_INTS))
+  if ((n >= 0) && (n < OP_MAX_DEFINED))
     return(small_int(sc, n));
   /* there are ca 6300 -1's in s7test (14500 small negative ints) -- if like sc->real_zero (64000), this would gain us .2% overall speed */
 
@@ -6324,16 +6297,12 @@
 {
   #define H_integer_to_char "(integer->char i) converts the non-negative integer i to a character"
   s7_pointer x;
-  int ind;
   x = car(args);
-
-  if (!s7_is_integer(x))
-    return(s7_wrong_type_arg_error(sc, "integer->char", 0, x, "an integer"));
-  ind = s7_integer(x);
-  if ((ind < 0) || (ind > 255))
+  if ((!s7_is_integer(x)) || 
+      (s7_integer(x) < 0) ||
+      (s7_integer(x) > 255))
     return(s7_wrong_type_arg_error(sc, "integer->char", 0, x, "an integer between 0 and 255"));
-
-  return(s7_make_character(sc, (char)ind));
+  return(s7_make_character(sc, (char)s7_integer(x)));
 }
 
 
@@ -6664,24 +6633,18 @@
   
   s7_pointer index;
   char *str;
-  int ind;
-
   index = cadr(args);
   
   if (!s7_is_string(car(args)))
     return(s7_wrong_type_arg_error(sc, "string-ref", 1, car(args), "a string"));
-  if (!s7_is_integer(index))
-    return(s7_wrong_type_arg_error(sc, "string-ref", 2, index, "an integer"));
-
-  ind = s7_integer(index);
-
-  if (ind < 0)
+  
+  if ((!s7_is_integer(index)) || (s7_integer(index) < 0))
     return(s7_wrong_type_arg_error(sc, "string-ref", 2, index, "a non-negative integer"));
-  if (ind >= string_length(car(args)))
+  if (s7_integer(index) >= string_length(car(args)))
     return(s7_out_of_range_error(sc, "string-ref", 2, index, "less than string length"));
   
   str = string_value(car(args));
-  return(s7_make_character(sc, ((unsigned char *)str)[ind]));
+  return(s7_make_character(sc, ((unsigned char *)str)[s7_integer(index)]));
 }
 
 
@@ -6691,7 +6654,6 @@
   
   s7_pointer x, index;
   char *str;
-  int ind;
 
   x = car(args);
   index = cadr(args);
@@ -6700,25 +6662,22 @@
     return(s7_wrong_type_arg_error(sc, "string-set!", 1, x, "a string"));
   if (!s7_is_character(caddr(args)))
     return(s7_wrong_type_arg_error(sc, "string-set!", 3, caddr(args), "a character"));
-  if (s7_is_immutable(x))
-    return(s7_wrong_type_arg_error(sc, "string-set!", 1, x, "a mutable string"));
-  if (!s7_is_integer(index))
-    return(s7_wrong_type_arg_error(sc, "string-set!", 2, index, "an integer"));
-
-  ind = s7_integer(index);
-
-  if (ind < 0)
+  
+  if ((!s7_is_integer(index)) || (s7_integer(index) < 0))
     return(s7_wrong_type_arg_error(sc, "string-set!", 2, index, "a non-negative integer"));
-  if (ind >= string_length(x))
+  if (s7_integer(index) >= string_length(x))
     return(s7_out_of_range_error(sc, "string-set!", 2, index, "less than string length"));
   
+  if (s7_is_immutable(x))
+    return(s7_wrong_type_arg_error(sc, "string-set!", 1, x, "a mutable string"));
+  
   /* I believe this does not need a lock in the multithread case -- local vars are specific
    *   to each thread, and it should be obvious to anyone writing such code that a global
    *   variable needs its lock (caller-supplied) -- it's not s7's job to protect even the
    *   caller's (scheme) variables.
    */
   str = string_value(x);
-  str[ind] = (char)s7_character(caddr(args));
+  str[s7_integer(index)] = (char)s7_character(caddr(args));
   return(x);
 }
 
@@ -9579,12 +9538,9 @@
 }
 
 
-static s7_pointer g_vector_length(s7_scheme *sc, s7_pointer args);
-static s7_pointer g_hash_table_size(s7_scheme *sc, s7_pointer args);
-
 static s7_pointer g_length(s7_scheme *sc, s7_pointer args)
 {
-  #define H_length "(length obj) returns the length of obj, which can be a list, vector, string, or hash-table"
+  #define H_length "(length lst) returns the length of the list lst"
   
   int len;
   s7_pointer lst = car(args);
@@ -9593,21 +9549,13 @@
     return(small_int(sc, 0));
   
   if (!is_pair(lst)) 
-    {
-      if (s7_is_vector(lst))
-	return(g_vector_length(sc, args));
-      if (s7_is_string(lst))
-	return(g_string_length(sc, args));
-      if (s7_is_hash_table(lst))
-	return(g_hash_table_size(sc, args));
-
-      return(s7_wrong_type_arg_error(sc, "length", 0, lst, "a list, vector, string, or hash-table"));
-    }
+    return(s7_wrong_type_arg_error(sc, "length", 0, lst, "a list"));
   
   len = s7_list_length(sc, lst);
   
   if (len < 0) 
     return(s7_wrong_type_arg_error(sc, "length:", 0, lst, "a proper (not a dotted) list"));
+  
   if (len == 0)
     return(s7_wrong_type_arg_error(sc, "length:", 0, lst, "a proper (not a circular) list"));
   
@@ -9784,7 +9732,6 @@
   #define H_vector_fill "(vector-fill! v val) sets all elements of the vector v to val"
   if (!s7_is_vector(car(args)))
     return(s7_wrong_type_arg_error(sc, "vector-fill!", 1, car(args), "a vector"));
-
   s7_vector_fill(sc, car(args), cadr(args));
   return(sc->UNSPECIFIED);
 }
@@ -10561,9 +10508,6 @@
   s7_pointer (*set)(s7_scheme *sc, s7_pointer obj, s7_pointer args);
 } s7_c_object_t;
 
-/* TODO: length copy fill, s7_new_type_extended? or a way to set these fields one at a time
- */
-
 
 static s7_c_object_t *object_types = NULL;
 static int object_types_size = 0;
@@ -11141,7 +11085,7 @@
 
 static s7_pointer g_hash_table_size(s7_scheme *sc, s7_pointer args)
 {
-  #define H_hash_table_size "(hash-table-size obj) returns the size of the hash-table obj"
+  #define H_hash_table_size "(hash-table-size obj) returnsthe size of the hash-table obj"
   if (!s7_is_hash_table(car(args)))
     return(s7_wrong_type_arg_error(sc, "hash-table-size", 0, car(args), "a hash-table"));
   return(s7_make_integer(sc, vector_length(car(args))));
@@ -12551,7 +12495,6 @@
 static s7_pointer g_quit(s7_scheme *sc, s7_pointer args)
 {
   #define H_quit "(quit) returns from the evaluator"
-
   push_stack(sc, OP_QUIT, sc->NIL, sc->NIL);
   return(sc->NIL);
 }
@@ -13228,9 +13171,6 @@
 
 
 static s7_pointer g_quasiquote_1(s7_scheme *sc, int level, s7_pointer form);
-#if WITH_ENCAPSULATION
-  static void encapsulate(s7_scheme *sc, s7_pointer sym);
-#endif
 
 
 /* -------------------------------- eval -------------------------------- */
@@ -13731,17 +13671,6 @@
 					  s7_make_string_with_length(sc, "~A: too many arguments: ~A", 26),
 					  sc->code, sc->args)));
 
-#if WITH_ENCAPSULATION
-	    /* this is 99% of the encapsulation cost when not using that feature --
-	     *   perhaps T_C_SET_FUNCTION? that slows down is_c_function which isn't actually used currently
-	     */
-
-	    if ((is_encapsulating(sc)) &&
-		(is_setter(sc->code)))
-	      {
-		encapsulate(sc, car(sc->args));
-	      }
-#endif
 	    sc->value = c_function_call(sc->code)(sc, sc->args);
 	    
 	    if (sc->stack_top != 0)
@@ -14154,8 +14083,8 @@
       /* if we're defining a function, add its symbol to the new function's environment under the name __func__ */
       if ((is_closure(sc->value)) || 
 	  (is_closure_star(sc->value)))
-	closure_environment(sc->value) = s7_cons(sc, 
-					   s7_cons(sc, 
+	closure_environment(sc->value) = s7_immutable_cons(sc, 
+					   s7_immutable_cons(sc, 
 					     s7_immutable_cons(sc, sc->__FUNC__, sc->code), 
                                              sc->NIL), 
 					   closure_environment(sc->value));
@@ -14191,12 +14120,6 @@
 	      goto EVAL;
 	    }
 	  
-#if WITH_ENCAPSULATION
-	  if (is_encapsulating(sc))
-	    {
-	      encapsulate(sc, caar(sc->code));
-	    }
-#endif
 	  sc->x = s7_symbol_value(sc, caar(sc->code));
 	  if ((is_c_object(sc->x)) &&
 	      (object_set_function(sc->x)))
@@ -14232,16 +14155,10 @@
       goto EVAL;
       
       
-    case OP_SET1:     
+    case OP_SET1:      
       sc->y = s7_find_symbol_in_environment(sc, sc->envir, sc->code, true);
       if (sc->y != sc->NIL) 
 	{
-#if WITH_ENCAPSULATION
-	  if (is_encapsulating(sc))
-	    {
-	      encapsulate(sc, sc->code);
-	    }
-#endif
 	  set_symbol_value(sc->y, sc->value); 
 	  pop_stack(sc);
 	  goto START;
@@ -15419,10 +15336,6 @@
   new_sc->code = new_sc->NIL;
   new_sc->args = new_sc->NIL;
   new_sc->value = new_sc->NIL;
-
-#if WITH_ENCAPSULATION
-  new_sc->encapsulators = sc->NIL;
-#endif
   
   new_sc->temps_size = GC_TEMPS_SIZE;
   new_sc->temps_ctr = 0;
@@ -15478,222 +15391,6 @@
 #endif
 
 
-
-
-/* -------------------------------- encapsulation -------------------------------- */
-
-/* encapsulate:
-
-   open-encapsulator, close-encapsulator, (obj) to restore, here's an encapsulate macro:
- 
-   (define-macro (encapsulate . body) 
-      (let ((encap (gensym)))
-        `(let ((,encap (open-encapsulator)))
-           (dynamic-wind
-              (lambda () 
-	        #f)
-              (lambda () 
-	        ,@body)
-              (lambda () 
-	        ((,encap))
-                (close-encapsulator ,encap))))))
- 
-    We want to run some code,  then return variables global to that code to their prior state.
-    We might simpy coply the entire current environment, but that is slow (there are easily 
-    10000 variables in Snd), and requires huge amounts of space (vectors need to be copied 
-    for example), and usually in such a situation, only one or two variables actually need to 
-    be restored.  My first thought was fluid-let, but "fluid-let" is a bad name; it is not a 
-    "let" because it uses set! rather than making a new binding, and what is "fluid" about it?  
-    It's also a bad idea because it puts a dumb bookkeeping burden on the programmer -- he has 
-    to maintain a list of the variables he wants to protect -- that's asking for bugs!  Finally, 
-    it's restricted to protecting the body of the not-really-a-let, but in a REPL, for example, 
-    you'd want to return to a known state without being in any obvious let form.  That is, we
-    actually want a sort of data-side call/cc. In this system (open|close-encapsulator), to be
-    able to return to a given (data) state, open an encapsulator, then later call it to restore 
-    all variables global to that object.  close-encapsulator says I'm done with it -- the
-    normal case is that calling the object restores all its stored values, then (if not closed)
-    it starts saving values again -- this way we can repeatedly return to a clean state without
-    opening a new encapsulator every time.
-
-    notes...
-    set! string-set! list-set! vector-set! vector-fill! generalized-set! string-fill! (reverse! sort! set-car!) [*load-path* et al]
-    if in encap, keep alist with old values if not member current-env and not already member saved-values
-    pop out of encap, restore all.  
-    nesting is a problem, as are cleanups upon errors etc (GC), maybe handled like trace-return
-    threads are a problem! -- each needs its own such stack, but we'll get crosstalk -- a non-encapsulated
-      section in one thread changes a variable that has been saved in an encapsulated section of another thread...
-    also what about stuff like vct-set, also the sets above as funcs are too late -- we need the symbol
-    will eventually need to add s7_define_setter or something for the s7_define_function T_SETTER case
- */
-
-#if WITH_ENCAPSULATION
-
-typedef struct {
-  s7_pointer bindings;
-  s7_pointer envir;
-} encap_t;
-
-static int encapsulator_tag = 0;
-
-
-static char *encapsulator_print(s7_scheme *sc, void *obj)
-{
-  /* show vars? */
-  char *buf;
-  encap_t *p = (encap_t *)obj;
-  buf = (char *)malloc(32 * sizeof(char));
-  snprintf(buf, 32, "#<encapsulator>");
-  return(buf);
-}
-
-
-static void encapsulator_free(void *obj)
-{
-  if (obj) free(obj);
-}
-
-
-static void encapsulator_mark(void *val)
-{
-  encap_t *f = (encap_t *)val;
-  if ((f) && (f->bindings)) /* possibly still in open_encapsulator */
-    {
-      S7_MARK(f->bindings);
-    }
-}
-
-
-static bool encapsulator_equal(void *obj1, void *obj2)
-{
-  return(obj1 == obj2);
-}
-
-
-static s7_pointer g_open_encapsulator(s7_scheme *sc, s7_pointer args)
-{
-  #define H_open_encapsulator "(open-encapsulator) opens an encapsulator; until it is closed, it will save variable values."
-
-  /* create object, add to s7 list */
-  encap_t *e;
-  s7_pointer obj;
-  e = (encap_t *)malloc(sizeof(encap_t));
-  e->bindings = sc->NIL;
-  e->envir = sc->envir;
-  obj = s7_make_object(sc, encapsulator_tag, (void *)e);  
-  sc->encapsulators = s7_cons(sc, obj, sc->encapsulators);
-  return(obj);
-}
-
-
-static s7_pointer g_close_encapsulator(s7_scheme *sc, s7_pointer args)
-{
-  #define H_close_encapsulator "(close-encapsulator obj) closes an encapsulator; it will no longer try to protect anything."
-
-  /* remove from s7 list */
-  encap_t *e;
-  s7_pointer x, obj;
-  
-  obj = car(args);
-  if ((!is_c_object(obj)) ||
-      (c_object_type(obj) != encapsulator_tag))
-    return(s7_wrong_type_arg_error(sc, "close-encapsulator", 0, obj, "an encapsulator"));
-
-  e = (encap_t *)s7_object_value(obj);
-  e->bindings = sc->NIL;
-  e->envir = sc->NIL;
-
-  if (obj == car(sc->encapsulators))
-    sc->encapsulators = cdr(sc->encapsulators);
-  else
-    {
-      for (x = sc->encapsulators; is_pair(x); x = cdr(x))
-	{
-	  s7_pointer y;
-	  y = cdr(x);
-	  if (obj == car(y))
-	    {
-	      cdr(x) = cdr(y);
-	      break;
-	    }
-	}
-    }
-  return(sc->UNSPECIFIED);
-}
-
-
-static s7_pointer g_is_encapsulator(s7_scheme *sc, s7_pointer args)
-{
-  #define H_is_encapsulator "(encapsulator? obj) returns #t if obj is an encapsulator"
-  return(make_boolean(sc, (is_c_object(car(args))) && (c_object_type(car(args)) == encapsulator_tag)));
-}
-
-
-static s7_pointer encapsulator_apply(s7_scheme *sc, s7_pointer obj, s7_pointer args)
-{
-  encap_t *e;
-  e = (encap_t *)s7_object_value(obj);
-
-  if (args == sc->NIL)
-    {
-      /* no args, restore all values */
-      s7_pointer x, y;
-      for (x = e->bindings; is_pair(x); x = cdr(x)) 
-	{
-	  y = s7_find_symbol_in_environment(sc, sc->envir, caar(x), true);
-	  if (y != sc->NIL)
-	    set_symbol_value(y, cdar(x));
-	}
-    }
-  else
-    {
-      if (s7_is_symbol(car(args)))
-	{
-	  /* find symbol in this encapsulation, return its value */
-	  s7_pointer y, sym;
-	  sym = car(args);
-	  for (y = e->bindings; is_pair(y); y = cdr(y)) 
-	    if (sym == car(y))
-	      return(cdr(y));
-	  
-	  return(sc->UNDEFINED);
-	}
-      else return(s7_wrong_type_arg_error(sc, "encapsulator", 0, car(args), "a symbol"));
-    }
-  return(obj);
-}
-
-
-static void encapsulate(s7_scheme *sc, s7_pointer sym)
-{
-  s7_pointer x;
-  for (x = sc->encapsulators; is_pair(x); x = cdr(x))
-    {
-      encap_t *e;
-      s7_pointer y;
-      bool ok = false;
-
-      e = (encap_t *)s7_object_value(car(x));
-
-      for (y = e->bindings; is_pair(y); y = cdr(y)) 
-	if (sym == car(y))
-	  {
-	    ok = true;
-	    break;
-	  }
-
-      if (!ok)
-	{
-	  y = s7_find_symbol_in_environment(sc, e->envir, sym, true);
-	  if (y != sc->NIL)
-	    e->bindings = s7_cons(sc, s7_cons(sc, sym, symbol_value(y)), e->bindings); /* will need copy object here eventually */
-	}
-    }
-}
-#endif
-
-
-
-
 /* -------------------------------- gmp/mpfr/mpc -------------------------------- */
 
 #if WITH_GMP
@@ -20134,10 +19831,6 @@
   sc->gensym_counter = (long *)calloc(1, sizeof(long));
   sc->tracing = (bool *)calloc(1, sizeof(bool));
 
-#if WITH_ENCAPSULATION
-  sc->encapsulators = sc->NIL;
-#endif
-
   sc->trace_list = (s7_pointer *)calloc(INITIAL_TRACE_LIST_SIZE, sizeof(s7_pointer));
   sc->trace_list_size = INITIAL_TRACE_LIST_SIZE;
   sc->trace_top = 0;
@@ -20153,8 +19846,8 @@
   sc->envir = sc->global_env;
   
   /* keep the small_ints out of the heap */
-  sc->small_ints = (s7_pointer *)malloc((NUM_SMALL_INTS + 1) * sizeof(s7_pointer));
-  for (i = 0; i <= NUM_SMALL_INTS; i++) 
+  sc->small_ints = (s7_pointer *)malloc((OP_MAX_DEFINED + 1) * sizeof(s7_pointer));
+  for (i = 0; i <= OP_MAX_DEFINED; i++) 
     {
       s7_pointer p;
       p = (s7_pointer)calloc(1, sizeof(s7_cell));
@@ -20623,13 +20316,6 @@
   g_provide(sc, make_list_1(sc, s7_make_symbol(sc, "threads")));
 #endif
 
-#if WITH_ENCAPSULATION
-  encapsulator_tag = s7_new_type("<encapsulator>",  encapsulator_print, encapsulator_free, encapsulator_equal, encapsulator_mark, encapsulator_apply, NULL);
-  s7_define_function(sc, "open-encapsulator",       g_open_encapsulator,       0, 0, false, H_open_encapsulator);
-  s7_define_function(sc, "close-encapsulator",      g_close_encapsulator,      1, 0, false, H_close_encapsulator);
-  s7_define_function(sc, "encapsulator?",           g_is_encapsulator,         1, 0, false, H_is_encapsulator);
-#endif
-
 #if WITH_MULTIDIMENSIONAL_VECTORS
   sc->VECTOR_SET = s7_symbol_value(sc, s7_make_symbol(sc, "vector-set!"));
   typeflag(sc->VECTOR_SET) |= T_DONT_COPY; 
@@ -20679,6 +20365,7 @@
   /* macroexpand */
   s7_eval_c_string(sc, "(define-macro (macroexpand mac) `(,(procedure-source (car mac)) (append (list ',(car mac)) ',(cdr mac))))");
 
+
   /* stacktrace -- move this into C eventually */
   s7_eval_c_string(sc, "                                                                       \n\
 (define* (stacktrace cont)                                                                     \n\
diff -ur snd-10/snd-sig.c snd-10-new/snd-sig.c
--- snd-10/snd-sig.c	2009-08-05 01:01:13.000000000 +0200
+++ snd-10-new/snd-sig.c	2010-11-18 01:11:33.164907546 +0100
@@ -5734,11 +5734,11 @@
 
   static mus_float_t all_mins[128] = {1.0000, 1.7600, 1.9797, 2.0390, 2.3435, 2.5493, 2.6394, 2.7947, 2.9618, 3.1027, 3.2185, 3.3894, 3.5252, 3.6148, 3.7707, 3.8769, 4.0179, 4.1595, 4.2714, 4.2972, 4.5025, 4.5965, 4.6269, 4.8284, 4.9111, 5.0273, 5.0836, 5.2679, 5.3326, 5.4512, 5.5607, 5.6193, 5.6965, 5.8160, 5.9479, 6.1241, 6.1956, 6.3050, 6.4762, 6.4878, 6.6028, 6.6817, 6.7939, 6.8350, 6.9962, 6.9547, 7.2168, 7.2732, 7.3943, 7.5149, 7.6053, 7.6894, 7.8233, 7.9121, 7.9984, 8.0261, 8.0141, 8.2107, 8.2735, 8.4214, 8.4479, 8.5318, 8.4967, 8.5701, 8.6660, 8.8047, 9.1124, 9.1591, 9.0524, 9.2568, 9.2908, 9.5112, 9.5244, 9.7072, 9.6856, 9.7336, 9.8787, 9.8857, 9.8901, 9.7647, 10.1324, 10.1749, 10.1495, 10.2924, 10.5646, 10.6828, 10.4265, 10.5557, 10.8021, 10.7360, 10.8762, 11.1877, 11.1997, 11.0737, 11.1708, 11.2879, 11.2232, 11.2492, 11.3409, 11.3453, 11.5530, 11.7391, 11.7234, 11.9448, 11.9507, 11.9097, 11.9613, 11.9986, 12.1649, 12.3428, 12.2566, 12.2453, 12.3834, 12.5320, 12.5544, 12.6276, 12.5782, 12.8358, 12.9358, 13.0008, 13.0728, 13.1257, 13.0175, 13.0962, 13.1070, 13.0867, 13.0299, 13.4039};
 
-  static mus_float_t odd_mins[128] = {1.0000, 1.5390, 1.7387, 2.0452, 2.3073, 2.5227, 2.6184, 2.7908, 2.8865, 3.0538, 3.1771, 3.3628, 3.4758, 3.5998, 3.7418, 3.8607, 3.9558, 4.0793, 4.1940, 4.3752, 4.4620, 4.6110, 4.7242, 4.8070, 4.9268, 5.0493, 5.1390, 5.2302, 5.3165, 5.4464, 5.5606, 5.6270, 5.7759, 5.8831, 6.0618, 6.0999, 6.2069, 6.2994, 6.3385, 6.5663, 6.6932, 6.6840, 6.8205, 6.9416, 6.9829, 7.0570, 7.1528, 7.2465, 7.4349, 7.5193, 7.6035, 7.7374, 7.8346, 7.9103, 8.0452, 8.0144, 8.1612, 8.2976, 8.2379, 8.5039, 8.4698, 8.5960, 8.4935, 8.6112, 8.7283, 9.0909, 9.1107, 9.2490, 9.1870, 9.2186, 9.2568, 9.4214, 9.7437, 9.6525, 9.7821, 9.8223, 9.9713, 9.9897, 9.9580, 10.1870, 10.2960, 10.2987, 10.2626, 10.3449, 10.5459, 10.5850, 10.7491, 10.7336, 10.8403, 10.6243, 10.9697, 11.1025, 11.2560, 10.9896, 11.0756, 11.3266, 11.5559, 11.3377, 11.7737, 11.7433, 11.8643, 11.7178, 11.9704, 11.9687, 12.1138, 12.1746, 12.0038, 12.2709, 12.4498, 12.2800, 12.3123, 12.6528, 12.5964, 12.7020, 12.5388, 12.8764, 12.8545, 12.9580, 13.1021, 12.9939, 12.8771, 13.2445, 13.3045, 13.1349, 13.5020, 13.4434, 13.3449, 13.5300};
+  static mus_float_t odd_mins[128] = {1.0000, 1.5390, 1.7387, 2.0452, 2.3073, 2.5227, 2.6184, 2.7908, 2.8865, 3.0538, 3.1771, 3.3628, 3.4758, 3.5998, 3.7418, 3.8607, 3.9558, 4.0793, 4.1940, 4.3752, 4.4620, 4.6110, 4.7242, 4.8070, 4.9268, 5.0493, 5.1390, 5.2302, 5.3165, 5.4464, 5.5606, 5.6270, 5.7759, 5.8831, 6.0618, 6.0999, 6.2069, 6.2994, 6.3385, 6.5663, 6.7026, 6.6840, 6.8205, 6.9416, 6.9829, 7.0570, 7.1528, 7.2465, 7.4349, 7.5193, 7.6035, 7.7374, 7.8346, 7.9103, 8.0570, 8.0144, 8.1612, 8.2976, 8.2379, 8.5156, 8.4698, 8.6778, 8.4935, 8.6112, 8.8584, 9.2052, 9.1107, 9.2490, 9.1870, 9.2839, 9.2568, 9.4386, 9.7437, 9.6701, 9.7821, 9.9192, 9.9713, 9.9897, 9.9580, 10.1870, 10.2960, 10.2987, 10.2626, 10.3449, 10.5459, 10.5850, 10.7491, 10.7336, 10.8403, 10.6243, 10.9697, 11.1025, 11.2560, 10.9896, 11.0756, 11.3266, 11.5559, 11.3377, 11.7737, 11.7433, 11.8643, 11.7178, 11.9704, 11.9687, 12.1138, 12.1746, 12.0038, 12.2709, 12.4498, 12.2800, 12.3123, 12.6528, 12.5964, 12.7020, 12.5388, 12.8764, 12.8545, 12.9580, 13.1021, 12.9939, 12.8771, 13.2900, 13.3045, 13.1349, 13.5020, 13.4434, 13.3449, 13.5300};
 
-  static mus_float_t prime_mins[128] = {1.0000, 1.7600, 1.9798, 2.1921, 2.4768, 2.8055, 3.0619, 3.2630, 3.3826, 3.6026, 3.7793, 3.9389, 4.1805, 4.3288, 4.4821, 4.6627, 4.7328, 5.0131, 5.2245, 5.3328, 5.4869, 5.5946, 5.8299, 5.9499, 6.0160, 6.2062, 6.3061, 6.3476, 6.5570, 6.6997, 6.8025, 7.0594, 7.0959, 7.2019, 7.4036, 7.5876, 7.6839, 7.8411, 7.8274, 7.9107, 8.0697, 8.1674, 8.4260, 8.5680, 8.6060, 8.7683, 8.8215, 9.0524, 9.1627, 9.0363, 9.4897, 9.4762, 9.5539, 9.6162, 9.9782, 10.2323, 10.1988, 10.2538, 10.2892, 10.4623, 10.7092, 10.8440, 10.7537, 10.9221, 11.1046, 10.9904, 11.4203, 11.5639, 11.3183, 11.4297, 11.5959, 11.7825, 11.8836, 11.6733, 11.7339, 12.1164, 12.1038, 12.1877, 12.5344, 12.6652, 12.8292, 12.7533, 12.9178, 12.6803, 12.9856, 13.0590, 13.3143, 13.2348, 13.4061, 13.4455, 13.4881, 13.5451, 13.3385, 13.7079, 13.7647, 13.7161, 14.3273, 14.3091, 14.4479, 14.5451, 14.8538, 14.7827, 14.7885, 14.9754, 15.1590, 15.1682, 15.4821, 15.4423, 15.2026, 15.3008, 15.3480, 15.5875, 15.6546, 15.5505, 15.9319, 15.9615, 15.9801, 16.1738, 16.2489, 16.1006, 16.0579, 16.4014, 16.5744, 16.2855, 16.6688, 16.5462, 16.8431, 16.9375};
+  static mus_float_t prime_mins[128] = {1.0000, 1.7600, 1.9798, 2.1921, 2.4768, 2.8055, 3.0619, 3.2630, 3.3826, 3.6026, 3.7793, 3.9389, 4.1805, 4.3288, 4.4821, 4.6627, 4.7328, 5.0131, 5.2245, 5.3328, 5.4869, 5.5946, 5.8299, 5.9499, 6.0160, 6.2062, 6.3061, 6.3476, 6.5570, 6.6997, 6.8025, 7.0594, 7.0959, 7.2019, 7.4036, 7.5876, 7.6839, 7.8411, 7.8274, 7.9107, 8.0697, 8.1674, 8.4260, 8.5680, 8.6060, 8.7683, 8.8215, 9.0524, 9.1627, 9.0363, 9.5002, 9.4762, 9.5539, 9.6162, 9.9782, 10.2323, 10.1988, 10.2538, 10.2892, 10.4623, 10.7092, 10.8440, 10.7537, 10.9221, 11.1046, 10.9904, 11.4203, 11.5639, 11.3183, 11.4297, 11.5959, 11.7825, 11.8836, 11.6733, 11.7339, 12.1164, 12.1038, 12.1877, 12.5344, 12.6652, 12.8292, 12.7533, 12.9178, 12.6803, 12.9856, 13.0590, 13.3143, 13.2348, 13.4061, 13.4455, 13.4881, 13.5451, 13.3385, 13.7239, 13.7647, 13.7983, 14.3273, 14.3091, 14.4479, 14.5451, 14.8538, 14.7827, 14.7885, 14.9754, 15.1590, 15.1682, 15.4821, 15.4423, 15.2026, 15.3218, 15.3480, 15.5875, 15.6546, 15.5505, 15.9319, 15.9615, 15.9801, 16.1738, 16.2489, 16.1225, 16.0579, 16.4014, 16.5744, 16.2855, 16.6688, 16.5462, 16.8431, 16.9375};
 
-  static mus_float_t even_mins[128] = {1.0000, 1.7602, 2.0215, 2.4306, 2.6048, 2.8370, 3.0470, 3.1976, 3.4542, 3.5589, 3.6567, 3.7876, 3.9733, 4.0981, 4.1938, 4.3272, 4.4921, 4.5716, 4.7571, 4.8465, 4.9435, 5.0906, 5.2096, 5.3455, 5.4625, 5.5764, 5.7049, 5.8003, 5.9163, 6.0151, 6.1343, 6.2347, 6.4222, 6.4396, 6.6475, 6.7414, 6.8175, 6.9708, 6.9600, 7.0834, 7.1365, 7.3673, 7.3740, 7.4257, 7.6293, 7.6566, 7.8176, 7.8446, 7.8823, 8.0704, 8.2782, 8.1110, 8.3345, 8.4774, 8.5795, 8.5369, 8.5913, 8.8918, 8.8306, 9.0434, 9.0579, 9.0624, 9.2557, 9.1991, 9.4432, 9.4138, 9.5039, 9.7161, 9.7173, 9.9586, 10.0297, 10.0959, 10.2229, 9.9548, 10.3156, 10.3364, 10.4300, 10.4688, 10.5455, 10.7513, 10.6701, 10.7888, 11.0266, 11.0067, 10.9919, 11.1253, 11.1283, 11.3620, 11.3392, 11.5466, 11.5208, 11.7124, 11.7182, 11.6081, 11.5435, 11.9014, 11.8575, 11.8555, 12.0663, 11.9255, 12.2940, 12.1391, 12.4209, 12.3174, 12.5057, 12.2678, 12.4979, 12.5796, 12.7024, 12.7138, 12.8146, 12.9564, 13.0701, 13.0542, 13.0533, 13.3545, 13.2483, 13.1801, 13.5450, 13.5506, 13.6723, 13.6759, 13.9004, 13.8163, 13.6392, 14.0329, 13.7406, 14.0186};
+  static mus_float_t even_mins[128] = {1.0000, 1.7602, 2.0215, 2.4306, 2.6048, 2.8370, 3.0470, 3.1976, 3.4542, 3.5589, 3.6567, 3.7876, 3.9733, 4.0981, 4.1938, 4.3272, 4.4921, 4.5716, 4.7571, 4.8465, 4.9435, 5.0906, 5.2096, 5.3455, 5.4625, 5.5764, 5.7049, 5.8003, 5.9163, 6.0151, 6.1343, 6.2347, 6.4222, 6.4396, 6.6475, 6.7414, 6.8175, 6.9708, 6.9600, 7.0834, 7.1365, 7.3673, 7.3740, 7.4257, 7.6293, 7.6566, 7.8176, 7.8446, 7.8823, 8.0704, 8.2782, 8.1110, 8.3345, 8.4774, 8.5795, 8.5369, 8.5913, 8.8918, 8.8306, 9.0434, 9.0579, 9.0624, 9.2557, 9.1991, 9.4432, 9.4138, 9.5039, 9.7161, 9.7173, 9.9586, 10.0297, 10.0959, 10.2229, 9.9548, 10.3156, 10.3364, 10.4300, 10.4688, 10.5455, 10.7513, 10.6701, 10.7888, 11.0266, 11.0067, 10.9919, 11.1789, 11.1283, 11.3620, 11.3392, 11.5466, 11.5208, 11.7124, 11.7182, 11.6081, 11.5435, 11.9014, 11.8575, 11.8717, 12.0663, 11.9255, 12.2940, 12.1391, 12.4209, 12.3174, 12.5057, 12.2678, 12.4979, 12.5796, 12.7024, 12.7138, 12.8146, 12.9564, 13.0701, 13.0542, 13.0533, 13.3545, 13.2483, 13.1801, 13.5648, 13.5506, 13.6723, 13.6759, 13.9004, 13.8163, 13.6392, 14.0329, 13.7406, 14.0186};
 
   auto mus_float_t saved_min(int ch, int nn);
   auto mus_float_t get_peak(mus_float_t *phases);
diff -ur snd-10/snd.h snd-10-new/snd.h
--- snd-10/snd.h	2009-08-05 01:01:12.000000000 +0200
+++ snd-10-new/snd.h	2010-11-18 01:11:33.169009655 +0100
@@ -71,7 +71,7 @@
 
 #include "snd-strings.h"
 
-#define SND_DATE "5-Aug-09"
+#define SND_DATE "4-Aug-09"
 #ifndef SND_VERSION
 #define SND_VERSION "10.8"
 #endif
